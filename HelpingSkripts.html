<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="module" src="config.js"></script>
        <script src="./priceMatrix.js"></script>
        <script src="skript.js"></script>
        <script src="skriptreferral.js"></script>
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                console.log("Checking priceMatrixlocal:", window.priceMatrixlocal);
            });
        </script>
        <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
        <title>HashSense Farm</title>
        <style>
            .lang-btn.active {
                background-color: #6c5ce7;
                color: white;
            }
            .lang-btn {
                margin: 0 5px;
                padding: 5px 10px;
                cursor: pointer;
                border: none;
                background: #dfe6e9;
                border-radius: 5px;
            }
            .accordion {
                margin-top: 20px;
            }
            .accordion button {
                background-color: #6c5ce7;
                color: white;
                padding: 10px;
                width: 100%;
                border: none;
                text-align: left;
                font-size: 16px;
                cursor: pointer;
                border-radius: 5px;
            }
            .accordion-content {
                display: none;
                padding: 10px;
                background-color: #f0f0f0;
                margin-top: 5px;
                border-radius: 5px;
            }
            pre code {
                white-space: pre-wrap;
                word-wrap: break-word;
            }

    </style>
</head>
<body>
    <div class="main-container">
        <div class="main-container">
            <header class="header">
                <div class="card-field">
                    <div class="card-title">CURRENT BITCOINPRICE</div>
                    <div class="card-content aligned">
                        <div class="icon-wrap">
                         <img src="bitcoin-910307_1280.webp" alt="BTC" class="card-icon">
                        </div>
                        <div class="value-wrap">
                            <select id="bitcoin-price-dropdown" onchange="updateBTCPrice();">
                                <option value="10000">10,000 $</option>
                                <option value="20000">20,000 $</option>
                                <option value="30000">30,000 $</option>    
                                <option value="40000">40,000 $</option>
                                <option value="50000">50,000 $</option>
                                <option value="60000">60,000 $</option>   
                                <option value="70000">70,000 $</option>
                                <option value="80000">80,000 $</option>
                                <option value="90000">90,000 $</option>
                                <option id="currentp" value="0">current price</option>
                                <option value="100000">100,000 $</option>
                                <option value="110000">110,000 $</option>
                                <option value="120000">120,000 $</option>
                                <option value="130000">130,000 $</option>
                                <option value="140000">140,000 $</option>
                                <option value="150000">150,000 $</option>
                                <option value="160000">160,000 $</option>
                                <option value="200000">200,000 $</option>
                                <option value="250000">250,000 $</option>
                                <option value="300000">300,000 $</option>
                                <option value="400000">400,000 $</option>   
                            </select>
                        </div>
                </div>
              </div>
              <div class="card-field">
                <div class="card-title">CURRENT GMT PRICE</div>
                <div class="card-content aligned">
                    <div class="icon-wrap">
                        <img src="GoMining_Logo.webp" alt="GMT" class="card-icon">
                    </div>
                    <div class="value-wrap">
                        <input type="number" id="gmt-token-price" placeholder="0.4269" step="0.0001">
                    </div>
                </div>
                  </div>
                  <div class="card-field">
                    <div class="card-title">SAT PER TH</div>
                    <div class="card-content">
                        <img src="sats-ordinals-sats-logo.png" alt="‚ö°" class="card-icon">
                      <input type="number" id="sat-TH" value="51" min="0" step="1">
                    </div>
                  </div>
                  <button class="icon-btn" onclick="fetchBTCPrice(); fetchGMTPrice();"><span class="material-icons">refresh</span></button>

            </header>
        </div>
    <div class="main-container">

        <header class="header header-actions">
            <div class="action-center">

                <div class="action-icons">
                    <button id="deBtn" class="lang-btn active">DE</button>
                    <button id="enBtn" class="lang-btn">EN</button>

                </div>
            </div>
        </header>
        <div class="content" id="content">
            <div id="deSection">
                <h1>HashFarm Skripts</h1>
                <p>Exportiere deine GoMining Transaktionen einfach per Skript.</p>
                <h2>Was macht dieses Skript?</h2>
                <p>Mit diesem Skript kannst du alle Transaktionen aus deinem GoMining Konto automatisch exportieren. Es durchsucht alle Seiten, sammelt die Daten und erstellt daraus eine CSV-Datei.</p>

                <h2>Anleitung</h2>
                <ol>
                    <li>Gehe in die <strong>Transaktions√ºbersicht</strong> auf GoMining.</li>
                    <li>√ñffne die <strong>Console</strong> mit <kbd>F12</kbd> und w√§hle den Reiter <strong>Console</strong>.</li>
                    <li>F√ºge das gesamte Skript in die Console ein und dr√ºcke <strong>Enter</strong>.</li>
                    <li>Ggf. musst du zuvor das einf√ºgen erlauben. "allow pasting" oder so</li>
                </ol>

                <h2>Ablauf</h2>
                <ul>
                    <li>Das Skript startet automatisch und sammelt alle Transaktionen.</li>
                    <li>Es klickt sich automatisch durch alle Seiten.</li>
                    <li>Am Ende wird eine CSV-Datei heruntergeladen.</li>
                </ul>

                <h2>CSV Aufbau</h2>
                <p>Die CSV hat folgende Felder (jeweils mit <strong>;</strong> getrennt):</p>
                <ul>
                    <li>Datum (Tag/Monat/Jahr)</li>
                    <li>Uhrzeit</li>
                    <li>Typ</li>
                    <li>Wert</li>
                    <li>W√§hrung (GMT oder BTC)</li>
                    <li>Status</li>
                </ul>

                <h2>Export abbrechen</h2>
                <p>Falls du den Export stoppen willst, kannst du jederzeit in der Console folgendes eintippen:</p>
                <pre><code>cancelGoMiningExport();</code></pre>
                <p>Das Skript beendet sich dann nach Abschluss der aktuellen Seite.</p>

                <h2>Hinweis</h2>
                <p>Bitte Geduld haben: Jede Seite braucht etwa 2 Sekunden zum Laden. Bei vielen Transaktionen kann der Export ein paar Minuten dauern.</p>
                <div class="accordion">
                    <button onclick="toggleAccordion('deScript')">üìú zeige Skript </button>
                    <div id="deScript" class="accordion-content">
                <pre>
                <code>
                    // Globale Abbruch-Variable
globalThis.cancelExport = false;

(async function() {
    window.cancelGoMiningExport = function() {
        cancelExport = true;
        console.log("Export wird nach der aktuellen Seite abgebrochen! üö´");
    };

    function getFirstRowKey() {
        const firstRow = document.querySelector('tbody tr');
        const date = firstRow?.querySelector('datetime-display span.text-muted')?.innerText.trim() || '';
        const time = firstRow?.querySelector('datetime-display span.fw-medium')?.innerText.trim() || '';
        const value = firstRow?.querySelector('[data-qa-column="value"] span.hidden-empty.ms-1 > span')?.innerText.trim() || '';
        const pageSpan = document.querySelector('div.w-100.d-flex.align-items-center.justify-content-center span.mx-2.p-2');
        const pageNumber = pageSpan?.innerText.trim() || '';
        return `${pageNumber}_${date}_${time}_${value}`;
    }

    function extractRows() {
        const rows = document.querySelectorAll('tbody tr');
        const extracted = [];

        rows.forEach(row => {
            const time = row.querySelector('datetime-display span.fw-medium')?.innerText.trim() || '';
            const date = row.querySelector('datetime-display span.text-muted')?.innerText.trim() || '';
            const type = row.querySelector('[data-qa-column="type"]')?.innerText.trim() || '';

            const valueElement = row.querySelector('[data-qa-column="value"]');
            let valueText = valueElement?.querySelector('span.hidden-empty.ms-1 > span')?.innerText.trim() || '';
            let isNegative = valueText.startsWith('-');
            valueText = valueText.replace('.', '#').replace(/[.,]/g, '').replace('#', ',');
            valueText = valueText.replace('+', '').replace('-', '');
            if (isNegative) {
                valueText = '-' + valueText;
            }

            let currency = '';
            if (valueElement?.querySelector('icon-gmt')) {
                currency = 'GMT';
            } else if (valueElement?.querySelector('icon-bitcoin-circle')) {
                currency = 'BTC';
            }

            const status = row.querySelector('[data-qa-column="status"]')?.innerText.trim() || '';

            extracted.push({ date, time, type, value: valueText, currency, status });
        });

        return extracted;
    }

    function exportToCSV(data) {
        let csv = "Date-DayMonthYear;Date-Time;Type;Value;Currency;Status\n";
        data.forEach(item => {
            csv += `"${item.date}";"${item.time}";"${item.type}";"${item.value}";"${item.currency}";"${item.status}"\n`;
        });

        let filename = "gomining_transactions.csv";
        const dateRangeElement = document.querySelector('.catalog-index_block-filter-item');
        if (dateRangeElement) {
            const dateText = dateRangeElement.innerText
                .trim()
                .replace(/\s+/g, '_')
                .replace(/[,]/g, '')
                .replace(/[^\w\-]/g, '');
            filename = `gomining_${dateText}.csv`;
        }

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function goMiningAutoExport() {
        let allData = [];
        let previousKey = getFirstRowKey();
        let pageCounter = 1;

        while (true) {
            if (cancelExport) {
                console.log("Export wurde manuell abgebrochen! üö´");
                break;
            }

            console.log(`page done ${pageCounter}...`);
            allData = allData.concat(extractRows());

            let icon = document.querySelector('icon-arrow-short[direction="right"]');
            let nextButton = icon?.closest('button');

            if (!nextButton || nextButton.disabled) {
                console.log("button not ready yet. waiting 2 seconds and try again...");
                await new Promise(r => setTimeout(r, 2000));
                icon = document.querySelector('icon-arrow-short[direction="right"]');
                nextButton = icon?.closest('button');

                if (!nextButton || nextButton.disabled) {
                    console.log("Weiter-Button weiterhin deaktiviert. Abbruch.");
                    break;
                }
            }

            nextButton.click();
            if (pageCounter % 10 === 0) {
                console.log(`Kurze Pause nach Seite ${pageCounter}...`);
                await new Promise(r => setTimeout(r, 2000));
            } else {
                await new Promise(r => setTimeout(r, 300));
            }

            let newKey = getFirstRowKey();
            if (newKey === previousKey) {
                console.log("Seite hat sich scheinbar nicht ver√§ndert. Warte 2 Sekunden und pr√ºfe erneut...");
                await new Promise(r => setTimeout(r, 2000));
                newKey = getFirstRowKey();

                if (newKey === previousKey) {
                    console.log("Seite hat sich wirklich nicht ver√§ndert. Speichere letzte Seite...");
                    allData = allData.concat(extractRows());
                    break;
                }
            }

            previousKey = newKey;
            pageCounter++;
        }

        if (allData.length > 0) {
            console.log(`Exportiere ${allData.length} Transaktionen...`);
            exportToCSV(allData);
        } else {
            console.log("Keine Daten zum Exportieren gesammelt.");
        }
    }

    await goMiningAutoExport();
})();
            </code>
                </pre>
                </div>  
            </div>  
                <button class="main-btn" onclick="window.location.href='farm2.html'">Zur√ºck zur Farm</button>
            </div>
         
  
            <div id="enSection" style="display:none">
                <h1>HashFarm Skripts</h1>
                <p>Export your GoMining transactions easily using a script.</p>
                <h2>What does this script do?</h2>
                <p>This script allows you to automatically export all your transactions from your GoMining account. It browses all pages, collects the data, and generates a CSV file.</p>

                <h2>Instructions</h2>
                <ol>
                    <li>Open the <strong>Transactions overview</strong> on GoMining.</li>
                    <li>Open the <strong>Console</strong> using <kbd>F12</kbd> and select the <strong>Console</strong> tab.</li>
                    <li>Paste the entire script into the console and press <strong>Enter</strong>.</li>
                </ol>

                <h2>Process</h2>
                <ul>
                    <li>The script starts automatically and collects all transactions.</li>
                    <li>It clicks through all pages automatically.</li>
                    <li>At the end, a CSV file is downloaded.</li>
                </ul>

                <h2>CSV structure</h2>
                <p>The CSV contains the following fields (each separated by <strong>;</strong>):</p>
                <ul>
                    <li>Date (day/month/year)</li>
                    <li>Time</li>
                    <li>Type</li>
                    <li>Value</li>
                    <li>Currency (GMT or BTC)</li>
                    <li>Status</li>
                </ul>

                <h2>Cancel export</h2>
                <p>If you want to stop the export, you can type the following into the console at any time:</p>
                <pre><code>cancelGoMiningExport();</code></pre>
                <p>The script will stop after finishing the current page.</p>

                <h2>Note</h2>
                <p>Please be patient: Each page takes about 2 seconds to load. With many transactions, the export can take several minutes.</p>
                <div class="accordion">
                    <button onclick="toggleAccordion('enScript')">üìú show Skript </button>
                    <div id="enScript" class="accordion-content">
                <pre>
                    <code>(async function() {
                let cancelExport = false;
                window.cancelGoMiningExport = function() {
                cancelExport = true;
                console.log("Export wird nach der aktuellen Seite abgebrochen! üö´");
                };
                function getFirstRowKey() {
                const firstRow = document.querySelector('tbody tr');
                const date = firstRow?.querySelector('datetime-display span.text-muted')?.innerText.trim() || '';
                const time = firstRow?.querySelector('datetime-display span.fw-medium')?.innerText.trim() || '';
                const value = firstRow?.querySelector('[data-qa-column="value"] span.hidden-empty.ms-1 > span')?.innerText.trim() || '';
                return `${date}_${time}_${value}`;
                }
                function extractRows() {
                const rows = document.querySelectorAll('tbody tr');
                const extracted = [];
                rows.forEach(row => {
                    const time = row.querySelector('datetime-display span.fw-medium')?.innerText.trim() || '';
                    const date = row.querySelector('datetime-display span.text-muted')?.innerText.trim() || '';
                    const type = row.querySelector('[data-qa-column="type"]')?.innerText.trim() || '';
                    const valueElement = row.querySelector('[data-qa-column="value"]');
                    let valueText = valueElement?.querySelector('span.hidden-empty.ms-1 > span')?.innerText.trim() || '';
                    let isNegative = valueText.startsWith('-');
                    valueText = valueText.replace('+', '').replace('-', '').replace('.', ',');
                    if (isNegative) valueText = '-' + valueText;
                    let currency = '';
                    if (valueElement?.querySelector('icon-gmt')) {
                        currency = 'GMT';
                    } else if (valueElement?.querySelector('icon-bitcoin-circle')) {
                        currency = 'BTC';
                    }
                    const status = row.querySelector('[data-qa-column="status"]')?.innerText.trim() || '';
                    extracted.push({ date, time, type, value: valueText, currency, status });
                });
                return extracted;
                }
                function exportToCSV(data) {
                let csv = "Date-DayMonthYear;Date-Time;Type;Value;Currency;Status\n";
                data.forEach(item => {
                    csv += `"${item.date}";"${item.time}";"${item.type}";"${item.value}";"${item.currency}";"${item.status}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "gomining_transactions.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                }
                async function goMiningAutoExport() {
                let allData = [];
                let previousKey = getFirstRowKey();
                let pageCounter = 1;
                while (true) {
                    if (cancelExport) {
                        console.log("Export wurde manuell abgebrochen! üö´");
                        break;
                    }
                    console.log(`Verarbeite Seite ${pageCounter}...`);
                    allData = allData.concat(extractRows());
                    const icon = document.querySelector('icon-arrow-short[direction="right"]');
                    if (!icon) {
                        console.log("Kein Weiter-Icon mehr gefunden. Abbruch.");
                        break;
                    }
                    const nextButton = icon.closest('button');
                    if (!nextButton || nextButton.disabled) {
                        console.log("Weiter-Button deaktiviert. Abbruch.");
                        break;
                    }
                    nextButton.click();
                    await new Promise(r => setTimeout(r, 2000));
                    const newKey = getFirstRowKey();
                    if (newKey === previousKey) {
                        console.log("Seite hat sich nicht ver√§ndert. Speichere letzte Seite...");
                        allData = allData.concat(extractRows());
                        break;
                    }
                    previousKey = newKey;
                    pageCounter++;
                }
                if (allData.length > 0) {
                    console.log(`Exportiere ${allData.length} Transaktionen...`);
                    exportToCSV(allData);
                } else {
                    console.log("Keine Daten zum Exportieren gesammelt.");
                }
                }
                await goMiningAutoExport();
                })();</code>
                </pre>
            </div>
                <button class="main-btn" onclick="window.location.href='farm2.html'">Back to your Farm</button>
              </div>
            </div>
        </div>
    </div>
        <footer class="footer">
            <p>&copy; 2024 HashFarm | Helping you mine smarter.</p>
        </footer>
    </div>

    <script>
        const deBtn = document.getElementById('deBtn');
        const enBtn = document.getElementById('enBtn');
        const deSection = document.getElementById('deSection');
        const enSection = document.getElementById('enSection');

        deBtn.addEventListener('click', () => {
            deSection.style.display = 'block';
            enSection.style.display = 'none';
            deBtn.classList.add('active');
            enBtn.classList.remove('active');
        });

        enBtn.addEventListener('click', () => {
            deSection.style.display = 'none';
            enSection.style.display = 'block';
            enBtn.classList.add('active');
            deBtn.classList.remove('active');
        });
        function toggleAccordion(id) {
                const content = document.getElementById(id);
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            }
    </script>
</body>
</html>
