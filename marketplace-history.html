<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashFarm - Marketplace History</title>
    
    <!-- SEO Meta Tags -->
    <meta property="og:title" content="HashFarm - GoMining Marketplace History">
    <meta property="og:description" content="Complete historical archive of all GoMining Marketplace transactions. Track all miner purchases, upgrades and marketplace activities.">
    <meta property="og:image" content="https://hashfarm.me/assets/preview.png">
    <meta property="og:url" content="https://hashfarm.me/marketplace-history.html">
    <meta property="og:type" content="website">
    <meta name="description" content="Historical archive of GoMining Marketplace. View all past transactions, purchases, and upgrades.">
    <meta name="keywords" content="GoMining history, marketplace archive, Bitcoin mining history, miner purchase history, BTC mining statistics">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .filter-btn.active {
            background-color: rgb(147, 51, 234);
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VQ2RT4JL4L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-VQ2RT4JL4L');
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <!-- Sidebar Navigation -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 w-64 h-full bg-gray-800 shadow-xl z-50 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">Navigation</h2>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <nav class="space-y-2">
                <a href="index.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <span class="material-icons">home</span>
                    <span>Home</span>
                </a>
                <a href="HashSense.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <span class="material-icons">calculate</span>
                    <span>HashSense Dashboard</span>
                </a>
                <a href="farm2.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <span class="material-icons">storage</span>
                    <span>Farm Manager</span>
                </a>
                <a href="marketplace.html" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <span class="material-icons">store</span>
                    <span>Marketplace Live</span>
                </a>
                <a href="marketplace-history.html" class="flex items-center gap-3 p-3 rounded-lg bg-purple-600 transition-colors">
                    <span class="material-icons">history</span>
                    <span>Marketplace History</span>
                </a>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gray-800 p-4 sticky top-0 z-40 shadow-lg">
            <div class="max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="toggleSidebar()" 
                            class="bg-gray-700 hover:bg-gray-600 p-2 rounded-lg transition-colors duration-200">
                        <span class="material-icons text-white">menu</span>
                    </button>
                    <h1 class="text-xl font-bold text-white">GoMining Marketplace History</h1>
                    <div class="flex items-center gap-2">
                        <span id="status-indicator" class="w-3 h-3 rounded-full bg-blue-500"></span>
                        <span id="status-text" class="text-sm text-gray-300">Archive</span>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <!-- Total Transactions -->
                    <div class="bg-gray-700 rounded-xl p-4 shadow-lg">
                        <h2 class="text-xs font-semibold mb-2 text-gray-300">TOTAL TRANSACTIONS</h2>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-blue-400">receipt_long</span>
                            <p id="total-count" class="text-2xl font-bold text-white">-</p>
                        </div>
                    </div>

                    <!-- Total Volume -->
                    <div class="bg-gray-700 rounded-xl p-4 shadow-lg">
                        <h2 class="text-xs font-semibold mb-2 text-gray-300">TOTAL VOLUME</h2>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-green-400">trending_up</span>
                            <p id="total-volume" class="text-2xl font-bold text-white">-</p>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div class="bg-gray-700 rounded-xl p-4 shadow-lg">
                        <h2 class="text-xs font-semibold mb-2 text-gray-300">DATE RANGE</h2>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-purple-400">date_range</span>
                            <p id="date-range" class="text-sm font-bold text-white">-</p>
                        </div>
                    </div>

                    <!-- Data Source -->
                    <div class="bg-gray-700 rounded-xl p-4 shadow-lg">
                        <h2 class="text-xs font-semibold mb-2 text-gray-300">DATA SOURCE</h2>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-yellow-400">cloud</span>
                            <p class="text-sm font-bold text-white">Cloudflare KV</p>
                        </div>
                    </div>
                </div>

                <!-- Search Controls -->
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                        <label class="text-sm font-semibold text-gray-300 whitespace-nowrap">Search in:</label>
                        <select id="search-field" 
                                class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 flex-shrink-0">
                            <option value="all">All Fields</option>
                            <option value="userId">User ID</option>
                            <option value="sourceId">Source ID (Seller)</option>
                            <option value="id">Transaction ID</option>
                            <option value="walletAddress">Wallet Address</option>
                            <option value="toWalletAddress">To Wallet Address</option>
                            <option value="fromWalletType">From Wallet Type</option>
                            <option value="nftId">NFT ID</option>
                            <option value="nftExternalUrlId">NFT External ID</option>
                            <option value="minerName">Miner Name</option>
                            <option value="amount">Amount</option>
                            <option value="currency">Currency</option>
                            <option value="type">Transaction Type</option>
                        </select>
                        <div class="flex-1 w-full md:w-auto">
                            <input type="text" 
                                   id="search-input" 
                                   placeholder="Enter search value..." 
                                   oninput="performSearch()"
                                   class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <button onclick="clearSearch()" 
                                class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors text-sm font-semibold flex items-center gap-2 whitespace-nowrap">
                            <span class="material-icons text-sm">clear</span>
                            Clear
                        </button>
                        <div id="search-results-count" class="text-sm text-gray-400 whitespace-nowrap"></div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex flex-wrap gap-2 items-center justify-between">
                    <!-- Filter Buttons -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByType('all')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition-colors text-xs font-semibold active">
                            all
                        </button>
                        <button onclick="filterByType('direct-purchase')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors text-xs font-semibold">
                            direct-purchase
                        </button>
                        <button onclick="filterByType('marketplace')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors text-xs font-semibold">
                            marketplace
                        </button>
                        <button onclick="filterByType('secondary')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors text-xs font-semibold">
                            secondary
                        </button>
                        <button onclick="filterByType('power-upgrade')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors text-xs font-semibold">
                            power-upgrade
                        </button>
                        <button onclick="filterByType('efficiency-upgrade')" 
                                class="filter-btn px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors text-xs font-semibold">
                            efficiency-upgrade
                        </button>
                    </div>

                    <!-- Load More & Refresh -->
                    <div class="flex flex-wrap gap-2">
                        <button onclick="loadToday()" 
                                id="load-today-btn"
                                class="px-4 py-2 rounded-lg bg-yellow-600 hover:bg-yellow-700 transition-colors text-sm font-semibold flex items-center gap-2">
                            <span class="material-icons text-sm">today</span>
                            Today
                        </button>
                        <button onclick="loadAll()" 
                                id="load-all-btn"
                                class="px-4 py-2 rounded-lg bg-orange-600 hover:bg-orange-700 transition-colors text-sm font-semibold flex items-center gap-2">
                            <span class="material-icons text-sm">all_inclusive</span>
                            Load All
                        </button>
                        <button onclick="loadMore()" 
                                id="load-more-btn"
                                class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors text-sm font-semibold flex items-center gap-2">
                            <span class="material-icons text-sm">add</span>
                            50 More
                        </button>
                        <button onclick="refreshHistory()" 
                                class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 transition-colors text-sm font-semibold flex items-center gap-2">
                            <span class="material-icons text-sm">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Transaction Feed -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <div class="mb-4 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Transaction History</h2>
                    <p class="text-gray-400 text-sm">All unique marketplace transactions stored permanently (deduplicated)</p>
                </div>
                <div class="bg-gray-700 rounded-lg px-4 py-2 text-sm">
                    <span class="text-gray-400">Showing:</span>
                    <span id="limit-display" class="text-white font-bold ml-2">0 / 0</span>
                </div>
            </div>

            <div id="transaction-feed" class="space-y-3">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-600 border-t-purple-500"></div>
                    <p class="mt-4 text-gray-400">Loading historical data...</p>
                </div>
                    
                <!-- Error State (hidden by default) -->
                <div id="error-state" class="hidden text-center py-12">
                    <span class="material-icons text-6xl text-red-400 mb-4">cloud_off</span>
                    <p class="text-red-400 font-bold text-xl mb-2">Cloudflare Worker Unavailable</p>
                    <p class="text-gray-400 text-sm mb-4">The worker might be paused or rate-limited. Please try again later.</p>
                    <button onclick="refreshHistory()" 
                            class="px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition-colors font-semibold">
                        Retry
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-sm">
            <p>&copy; 2026 HashFarm. All rights reserved.</p>
            <div class="mt-2 space-x-4">
                <a href="imprint.html" class="hover:text-white transition-colors">Imprint</a>
                <a href="privacy-policy.html" class="hover:text-white transition-colors">Privacy</a>
                <a href="terms-of-service.html" class="hover:text-white transition-colors">Terms</a>
            </div>
        </div>
    </footer>

    <script>
        // Configuration
        const CONFIG = {
            WORKER_URL: 'https://gomining-marketplace.cimerawow.workers.dev',
            INITIAL_LIMIT: 500,
            LOAD_MORE_INCREMENT: 500
        };

        let allTransactions = [];
        let displayedTransactions = [];
        let currentFilter = 'all';
        let currentLimit = CONFIG.INITIAL_LIMIT;
        let searchActive = false;
        let searchResults = [];

        // Toggle sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Load history from Worker
        async function loadHistory(limit = CONFIG.INITIAL_LIMIT) {
            try {
                updateStatus('loading');
                const response = await fetch(`${CONFIG.WORKER_URL}/history?limit=${limit}`);
                
                if (!response.ok) {
                    throw new Error(`Cloudflare Worker Error (HTTP ${response.status})`);
                }
                
                const data = await response.json();
                
                if (data.transactions && data.transactions.length > 0) {
                    allTransactions = processTransactions(data.transactions);
                    updateStatistics();
                    filterByType(currentFilter);
                    updateStatus('loaded');
                    updateLimitDisplay();
                    
                    // Hide loading, show error state if needed
                    const loadingState = document.getElementById('loading-state');
                    const errorState = document.getElementById('error-state');
                    if (loadingState) loadingState.classList.add('hidden');
                    if (errorState) errorState.classList.add('hidden');
                } else {
                    const loadingState = document.getElementById('loading-state');
                    if (loadingState) {
                        loadingState.innerHTML = `
                            <div class="text-center py-12 text-gray-400">
                                <span class="material-icons text-6xl mb-4">history</span>
                                <p class="text-xl">No historical data available yet</p>
                                <p class="text-sm mt-2">Transactions will appear here as they are captured</p>
                            </div>
                        `;
                    }
                    updateStatus('empty');
                }
                
            } catch (error) {
                console.error('Error loading history:', error);
                
                // Show Cloudflare error state
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) {
                    errorState.classList.remove('hidden');
                    // Update error message
                    const errorMsg = errorState.querySelector('p.text-gray-400');
                    if (errorMsg && error.message.includes('Cloudflare')) {
                        errorMsg.textContent = error.message + ' - The worker might be paused or rate-limited.';
                    }
                }
                
                updateStatus('error');
            }
        }

        // Process transactions from KV storage
        function processTransactions(transactions) {
            return transactions.map(tx => {
                const details = tx.data && tx.data[0] ? tx.data[0] : {};
                
                // Determine transaction type
                let type = 'purchase';
                let typeLabel = 'Purchase';
                let extraInfo = '';
                
                if (details.type === 'nftPowerUpgrade') {
                    type = 'power-upgrade';
                    typeLabel = 'TH/s Upgrade';
                } else if (details.type === 'nftEnergyEfficiencyUpgrade') {
                    type = 'efficiency-upgrade';
                    typeLabel = 'Efficiency Upgrade';
                    extraInfo = `${details.fromEnergyEfficiency}W → ${details.toEnergyEfficiency}W`;
                } else if (tx.type === 'nft-payment') {
                    type = 'direct-purchase';
                    typeLabel = 'Primary Market';
                } else if (tx.type === 'nft-marketplace-payment') {
                    // Determine currency/chain
                    const currency = details.fromWalletType || tx.walletType || 'Unknown';
                    
                    if (details.fromWalletType && details.fromWalletType !== 'VIRTUAL_GMT') {
                        type = 'secondary';
                        typeLabel = `Secondary Market (${currency})`;
                    } else {
                        type = 'marketplace';
                        typeLabel = `Marketplace (${currency})`;
                    }
                }
                
                // Calculate TH/s
                let ths = 0;
                let displayThs = '';
                if (type === 'power-upgrade') {
                    const fromPower = parseFloat(details.fromPower || 0);
                    const toPower = parseFloat(details.toPower || 0);
                    ths = toPower - fromPower;
                    displayThs = `+${ths.toFixed(2)} TH/s (${fromPower.toFixed(2)} → ${toPower.toFixed(2)})`;
                } else if (type === 'efficiency-upgrade') {
                    ths = parseFloat(details.nftPower || 0);
                    displayThs = ths > 0 ? `${ths.toFixed(2)} TH/s` : '-';
                } else {
                    ths = parseFloat(details.nftPower || 0);
                    displayThs = `${ths.toFixed(2)} TH/s`;
                }
                
                // Determine efficiency
                let efficiency = '-';
                if (type === 'efficiency-upgrade') {
                    efficiency = extraInfo;
                } else if (details.nftEnergyEfficiency) {
                    efficiency = `${details.nftEnergyEfficiency}W/TH`;
                } else if (details.toEnergyEfficiency) {
                    efficiency = `${details.toEnergyEfficiency}W/TH`;
                }
                
                return {
                    id: tx.id,
                    sourceId: tx.sourceId || '-',
                    timestamp: new Date(tx.createdAt).getTime(),
                    createdAt: tx.createdAt,
                    storedAt: tx.stored_at,
                    type: type,
                    typeLabel: typeLabel,
                    typeRaw: tx.type,
                    detailType: details.type || '-',
                    amount: tx.value || 0,
                    amountUSD: tx.usdValue || null,
                    currency: tx.currency || 'GMT',
                    nftId: details.nftId || '-',
                    nftExternalUrlId: details.nftExternalUrlId || '-',
                    minerName: details.nftName || 'Unknown Miner',
                    minerImage: details.nftSmallImageUrl || '',
                    ths: ths,
                    displayThs: displayThs,
                    efficiency: efficiency,
                    fromPower: details.fromPower || '-',
                    toPower: details.toPower || '-',
                    fromEfficiency: details.fromEnergyEfficiency || '-',
                    toEfficiency: details.toEnergyEfficiency || '-',
                    userId: tx.userId,
                    walletAddress: tx.walletAddress || '-',
                    walletType: tx.walletType || '-',
                    fromWalletType: details.fromWalletType || '-',
                    toWalletAddress: details.toWalletAddress || '-',
                    fromUserId: details.fromUserId || '-',
                    toUserId: details.toUserId || tx.userId
                };
            });
        }

        // Update statistics
        function updateStatistics() {
            const totalCount = allTransactions.length;
            const totalVolume = allTransactions.reduce((sum, tx) => sum + (tx.amountUSD || tx.amount), 0);
            
            // Date range
            const timestamps = allTransactions.map(tx => tx.timestamp).sort((a, b) => a - b);
            const oldest = timestamps[0] ? new Date(timestamps[0]).toLocaleDateString() : '-';
            const newest = timestamps[timestamps.length - 1] ? new Date(timestamps[timestamps.length - 1]).toLocaleDateString() : '-';
            
            document.getElementById('total-count').textContent = totalCount.toLocaleString();
            document.getElementById('total-volume').textContent = `$${totalVolume.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('date-range').textContent = `${oldest} - ${newest}`;
        }

        // Update limit display
        function updateLimitDisplay() {
            const limitDisplay = document.getElementById('limit-display');
            if (limitDisplay && displayedTransactions.length > 0) {
                const showing = Math.min(currentLimit, displayedTransactions.length);
                limitDisplay.textContent = `${showing} / ${displayedTransactions.length}`;
            } else if (limitDisplay) {
                limitDisplay.textContent = '0 / 0';
            }
        }

        // Perform search
        function performSearch() {
            const field = document.getElementById('search-field').value;
            const searchValue = document.getElementById('search-input').value.trim();
            const resultsCount = document.getElementById('search-results-count');
            
            if (!searchValue) {
                // If search is empty, show filtered results
                searchActive = false;
                searchResults = [];
                renderTransactions();
                resultsCount.textContent = '';
                return;
            }
            
            searchActive = true;
            const searchLower = searchValue.toLowerCase();
            
            // Search in all transactions (before type filter)
            searchResults = allTransactions.filter(tx => {
                if (field === 'all') {
                    // Search in all text fields
                    return (
                        tx.userId?.toString().toLowerCase().includes(searchLower) ||
                        tx.sourceId?.toString().toLowerCase().includes(searchLower) ||
                        tx.id?.toLowerCase().includes(searchLower) ||
                        tx.walletAddress?.toLowerCase().includes(searchLower) ||
                        tx.toWalletAddress?.toLowerCase().includes(searchLower) ||
                        tx.fromWalletType?.toLowerCase().includes(searchLower) ||
                        tx.nftId?.toString().toLowerCase().includes(searchLower) ||
                        tx.nftExternalUrlId?.toLowerCase().includes(searchLower) ||
                        tx.minerName?.toLowerCase().includes(searchLower) ||
                        tx.amount?.toString().includes(searchLower) ||
                        tx.currency?.toLowerCase().includes(searchLower) ||
                        tx.type?.toLowerCase().includes(searchLower) ||
                        tx.typeLabel?.toLowerCase().includes(searchLower)
                    );
                } else {
                    // Search in specific field
                    const fieldValue = tx[field];
                    if (fieldValue === undefined || fieldValue === '-') return false;
                    return fieldValue.toString().toLowerCase().includes(searchLower);
                }
            });
            
            resultsCount.textContent = `${searchResults.length} result${searchResults.length !== 1 ? 's' : ''}`;
            renderTransactions();
            updateLimitDisplay();
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-field').value = 'all';
            searchActive = false;
            searchResults = [];
            document.getElementById('search-results-count').textContent = '';
            renderTransactions();
            updateLimitDisplay();
        }

        // Filter transactions by type
        function filterByType(type) {
            currentFilter = type;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-600');
                btn.classList.add('bg-gray-700');
            });
            
            // Find and activate the clicked button by checking onclick attribute
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${type}'`)) {
                    btn.classList.add('active', 'bg-purple-600');
                    btn.classList.remove('bg-gray-700');
                }
            });
            
            // Re-render with new filter (works with search too)
            renderTransactions();
            updateLimitDisplay();
        }

        // Render transactions
        function renderTransactions() {
            const feed = document.getElementById('transaction-feed');
            const loadingState = document.getElementById('loading-state');
            
            if (loadingState) {
                loadingState.remove();
            }
            
            // Start with search results if search is active, otherwise all transactions
            let baseTransactions = searchActive ? searchResults : allTransactions;
            
            // Apply type filter
            if (currentFilter === 'all') {
                displayedTransactions = [...baseTransactions];
            } else {
                displayedTransactions = baseTransactions.filter(tx => tx.type === currentFilter);
            }
            
            if (displayedTransactions.length === 0) {
                feed.innerHTML = `
                    <div class="text-center py-12 text-gray-400">
                        <span class="material-icons text-6xl mb-4">inbox</span>
                        <p>${searchActive ? 'No transactions found matching your search' : 'No transactions found'}</p>
                    </div>
                `;
                const loadMoreContainer = document.getElementById('load-more-container');
                if (loadMoreContainer) {
                    loadMoreContainer.classList.add('hidden');
                }
                return;
            }
            
            // Limit displayed transactions
            const limited = displayedTransactions.slice(0, currentLimit);
            feed.innerHTML = limited.map(tx => createTransactionCard(tx)).join('');
            
            // Show/hide load more button
            const loadMoreContainer = document.getElementById('load-more-container');
            if (loadMoreContainer) {
                if (displayedTransactions.length > currentLimit) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
            }
            
            updateLimitDisplay();
        }

        // Create transaction card HTML
        function createTransactionCard(tx) {
            // Icon and color based on type
            let typeIcon = 'shopping_cart';
            let typeColor = 'text-blue-400';
            
            switch(tx.type) {
                case 'power-upgrade':
                    typeIcon = 'upgrade';
                    typeColor = 'text-green-400';
                    break;
                case 'efficiency-upgrade':
                    typeIcon = 'bolt';
                    typeColor = 'text-yellow-400';
                    break;
                case 'direct-purchase':
                    typeIcon = 'store';
                    typeColor = 'text-purple-400';
                    break;
                case 'marketplace':
                    typeIcon = 'shopping_cart';
                    typeColor = 'text-blue-400';
                    break;
                case 'secondary':
                    typeIcon = 'swap_horiz';
                    typeColor = 'text-orange-400';
                    break;
                default:
                    typeIcon = 'help_outline';
                    typeColor = 'text-gray-400';
            }
            
            const timestamp = new Date(tx.timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Format amount
            let amountDisplay = '';
            if (tx.amountUSD && tx.amountUSD > 0) {
                amountDisplay = `${formatCurrency(tx.amountUSD)} (${tx.amount.toFixed(2)} ${tx.currency})`;
            } else {
                amountDisplay = `${tx.amount.toFixed(2)} ${tx.currency}`;
            }
            
            // Miner image
            const minerImageHTML = tx.minerImage 
                ? `<img src="${tx.minerImage}" alt="${tx.minerName}" class="w-16 h-16 rounded-lg object-cover" onerror="this.style.display='none'">` 
                : '';
            
            // Build upgrade details
            let upgradeDetails = '';
            if (tx.type === 'power-upgrade' && tx.fromPower !== '-' && tx.toPower !== '-') {
                upgradeDetails = `<div class="bg-gray-800 rounded px-2 py-1"><span class="text-gray-400">Power Upgrade:</span> <span class="text-green-400 font-semibold">${tx.fromPower} TH/s → ${tx.toPower} TH/s</span></div>`;
            } else if (tx.type === 'efficiency-upgrade' && tx.fromEfficiency !== '-' && tx.toEfficiency !== '-') {
                upgradeDetails = `<div class="bg-gray-800 rounded px-2 py-1"><span class="text-gray-400">Efficiency Upgrade:</span> <span class="text-green-400 font-semibold">${tx.fromEfficiency}W → ${tx.toEfficiency}W</span></div>`;
            } else if ((tx.type === 'marketplace' || tx.type === 'secondary') && tx.fromWalletType !== '-') {
                // Marketplace P2P transaction - show USER + WALLET flow (FULL transparency)
                // Source ID = Seller User ID!
                const fromUser = tx.sourceId !== '-' ? `User ${tx.sourceId}` : 'Unknown Seller';
                const fromWallet = tx.walletAddress; // Seller's actual wallet address
                const toUser = `User ${tx.userId}`;
                const toWallet = tx.toWalletAddress !== '-' ? tx.toWalletAddress : '-'; // Buyer's wallet address
                upgradeDetails = `<div class="bg-blue-900 rounded px-3 py-2 border border-blue-500">
                    <div class="text-blue-300 font-semibold mb-2">P2P Transfer:</div>
                    <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                        <div class="flex-1">
                            <div class="text-blue-200 text-xs mb-1">Seller:</div>
                            <div class="text-white font-bold">${fromUser}</div>
                            <div class="text-gray-300 font-mono text-xs break-all">${fromWallet}</div>
                        </div>
                        <div class="text-blue-400 text-2xl px-2">→</div>
                        <div class="flex-1">
                            <div class="text-blue-200 text-xs mb-1">Buyer:</div>
                            <div class="text-white font-bold">${toUser}</div>
                            <div class="text-gray-300 font-mono text-xs break-all">${toWallet}</div>
                        </div>
                    </div>
                </div>`;
            }
            
            return `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        ${minerImageHTML}
                        <div class="flex items-start gap-3 flex-1">
                            <span class="material-icons ${typeColor} text-3xl">${typeIcon}</span>
                            <div class="flex-1">
                                <!-- Header -->
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-bold text-lg">${tx.typeLabel}</span>
                                    <span class="text-gray-500 text-xs">(${tx.typeRaw})</span>
                                </div>
                                
                                <!-- Miner Name & NFT ID -->
                                <div class="mb-2">
                                    <a href="${getMinerLink(tx)}" target="_blank" class="text-purple-400 font-semibold hover:text-purple-300 hover:underline">${tx.minerName}</a>
                                    ${tx.nftId !== '-' ? `<span class="text-gray-500 text-xs ml-2">NFT #${tx.nftId}</span>` : ''}
                                </div>
                                
                                <!-- Upgrade Details (if applicable) -->
                                ${upgradeDetails ? `<div class="mb-2">${upgradeDetails}</div>` : ''}
                                
                                <!-- Main Stats Grid -->
                                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm mb-2">
                                    <div>
                                        <span class="text-gray-400">Amount:</span>
                                        <span class="text-white font-semibold ml-1 block md:inline">${amountDisplay}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Power:</span>
                                        <span class="text-white font-semibold ml-1 block md:inline">${tx.displayThs}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Efficiency:</span>
                                        <span class="text-white font-semibold ml-1">${tx.efficiency}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">User ID:</span>
                                        <span class="text-white font-semibold ml-1">${tx.userId}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-400">Wallet Type:</span>
                                        <span class="text-white font-semibold ml-1 text-xs">${tx.walletType}</span>
                                    </div>
                                </div>
                                
                                <!-- Transaction Details -->
                                <div class="bg-gray-800 rounded p-2 mb-2 text-xs">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <div class="break-all">
                                            <span class="text-gray-400">TX ID:</span>
                                            <span class="text-white font-mono">${tx.id}</span>
                                        </div>
                                        ${tx.sourceId !== '-' ? `
                                        <div class="break-all">
                                            <span class="text-gray-400">Source ID:</span>
                                            <span class="text-white font-mono">${tx.sourceId}</span>
                                        </div>` : ''}
                                        ${tx.walletAddress !== '-' ? `
                                        <div class="break-all">
                                            <span class="text-gray-400">Wallet:</span>
                                            <span class="text-white font-mono">${tx.walletAddress}</span>
                                        </div>` : ''}
                                        ${tx.detailType !== '-' ? `
                                        <div>
                                            <span class="text-gray-400">Detail Type:</span>
                                            <span class="text-white">${tx.detailType}</span>
                                        </div>` : ''}
                                    </div>
                                </div>
                                
                                <!-- Wallet Flow (if applicable) -->
                                ${tx.fromWalletType !== '-' || tx.toWalletAddress !== '-' ? `
                                <div class="bg-gray-800 rounded p-2 text-xs mb-2">
                                    <div class="flex items-start gap-2 flex-wrap">
                                        ${tx.fromWalletType !== '-' ? `
                                        <div class="flex items-start gap-1">
                                            <span class="material-icons text-xs text-gray-400">arrow_forward</span>
                                            <span class="text-gray-400">From:</span>
                                            <span class="text-white font-semibold break-all">${tx.fromWalletType}</span>
                                        </div>` : ''}
                                        ${tx.toWalletAddress !== '-' ? `
                                        <div class="flex items-start gap-1">
                                            <span class="material-icons text-xs text-gray-400">arrow_forward</span>
                                            <span class="text-gray-400">To:</span>
                                            <span class="text-white font-mono text-xs break-all">${tx.toWalletAddress}</span>
                                        </div>` : ''}
                                    </div>
                                </div>` : ''}
                                
                                <!-- Stored timestamp -->
                                <div class="text-xs text-gray-500">
                                    <span class="text-gray-400">Stored:</span> ${new Date(tx.storedAt).toLocaleString('en-US')}
                                </div>
                            </div>
                        </div>
                        <div class="text-right text-xs text-gray-400 ml-4 whitespace-nowrap">
                            ${timestamp}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get miner link (use nftExternalUrlId - the actual UUID)
        function getMinerLink(tx) {
            const baseUrl = 'https://app.gomining.com/nft/view/';
            
            // Use nftExternalUrlId if available (this is the correct UUID)
            if (tx.nftExternalUrlId && tx.nftExternalUrlId !== '-') {
                return baseUrl + tx.nftExternalUrlId;
            }
            
            // Fallback: use nftId if available
            return tx.nftId !== '-' ? baseUrl + tx.nftId : '#';
        }

        // Format currency
        function formatCurrency(value) {
            if (value === '-' || value === null || value === undefined) return '-';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // Update status indicator
        function updateStatus(status) {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            
            switch(status) {
                case 'loading':
                    indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 pulse';
                    text.textContent = 'Loading...';
                    break;
                case 'loaded':
                    indicator.className = 'w-3 h-3 rounded-full bg-green-500';
                    text.textContent = 'Loaded';
                    break;
                case 'empty':
                    indicator.className = 'w-3 h-3 rounded-full bg-gray-500';
                    text.textContent = 'Empty';
                    break;
                case 'error':
                    indicator.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = 'Error';
                    break;
            }
        }

        // Load more transactions
        function loadMore() {
            currentLimit += CONFIG.LOAD_MORE_INCREMENT;
            renderTransactions();
            updateLimitDisplay();
        }
        
        // Load Today's transactions (FROM SERVER)
        async function loadToday() {
            try {
                updateStatus('loading');
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) {
                    loadingState.classList.remove('hidden');
                    loadingState.innerHTML = `
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-600 border-t-purple-500"></div>
                        <p class="mt-4 text-gray-400">Loading today's transactions from server...</p>
                    `;
                }
                if (errorState) errorState.classList.add('hidden');
                
                // Fetch ALL transactions from server
                const response = await fetch(`${CONFIG.WORKER_URL}/history`);
                
                if (!response.ok) {
                    throw new Error(`Cloudflare Worker Error (HTTP ${response.status})`);
                }
                
                const data = await response.json();
                
                if (!data.transactions || data.transactions.length === 0) {
                    alert('No transactions available from server');
                    loadHistory();
                    return;
                }
                
                // Process all transactions
                const allTx = processTransactions(data.transactions);
                
                // Filter for today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                
                const todayTransactions = allTx.filter(tx => {
                    const txDate = new Date(tx.createdAt);
                    txDate.setHours(0, 0, 0, 0);
                    return txDate.getTime() === todayTimestamp;
                });
                
                if (todayTransactions.length === 0) {
                    alert('No transactions found for today');
                    loadHistory();
                    return;
                }
                
                // Update state
                allTransactions = todayTransactions;
                displayedTransactions = todayTransactions;
                currentLimit = CONFIG.INITIAL_LIMIT;  // Respect user's limit setting
                currentFilter = 'all';
                searchActive = false;
                searchResults = [];
                
                if (document.getElementById('search-input')) {
                    document.getElementById('search-input').value = '';
                }
                if (document.getElementById('search-results-count')) {
                    document.getElementById('search-results-count').textContent = '';
                }
                
                // Update filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600');
                    btn.classList.add('bg-gray-700');
                });
                const allBtn = document.querySelector('.filter-btn[onclick*=\"all\"]');
                if (allBtn) {
                    allBtn.classList.add('active', 'bg-purple-600');
                    allBtn.classList.remove('bg-gray-700');
                }
                
                if (loadingState) loadingState.classList.add('hidden');
                
                updateStatistics();
                renderTransactions();
                updateLimitDisplay();
                updateStatus('loaded');
                
            } catch (error) {
                console.error('Error loading today:', error);
                
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) {
                    errorState.classList.remove('hidden');
                    const errorMsg = errorState.querySelector('p.text-gray-400');
                    if (errorMsg) {
                        errorMsg.textContent = `Failed to load today's transactions: ${error.message}`;
                    }
                }
                
                updateStatus('error');
            }
        }
        
        // Load All transactions (FROM SERVER)
        async function loadAll() {
            try {
                updateStatus('loading');
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) {
                    loadingState.classList.remove('hidden');
                    loadingState.innerHTML = `
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-600 border-t-purple-500"></div>
                        <p class="mt-4 text-gray-400">Loading ALL transactions from server...</p>
                    `;
                }
                if (errorState) errorState.classList.add('hidden');
                
                // Fetch ALL transactions from server
                const response = await fetch(`${CONFIG.WORKER_URL}/history`);
                
                if (!response.ok) {
                    throw new Error(`Cloudflare Worker Error (HTTP ${response.status})`);
                }
                
                const data = await response.json();
                
                if (!data.transactions || data.transactions.length === 0) {
                    alert('No transactions available from server');
                    loadHistory();
                    return;
                }
                
                // Process all transactions
                allTransactions = processTransactions(data.transactions);
                
                // Confirm if large dataset
                if (allTransactions.length > 500) {
                    const confirmed = confirm(`This will display all ${allTransactions.length} transactions. This might be slow. Continue?`);
                    if (!confirmed) {
                        loadHistory();
                        return;
                    }
                }
                
                currentLimit = allTransactions.length;
                currentFilter = 'all';
                searchActive = false;
                searchResults = [];
                
                if (document.getElementById('search-input')) {
                    document.getElementById('search-input').value = '';
                }
                if (document.getElementById('search-results-count')) {
                    document.getElementById('search-results-count').textContent = '';
                }
                
                // Update filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600');
                    btn.classList.add('bg-gray-700');
                });
                const allBtn = document.querySelector('.filter-btn[onclick*=\"all\"]');
                if (allBtn) {
                    allBtn.classList.add('active', 'bg-purple-600');
                    allBtn.classList.remove('bg-gray-700');
                }
                
                if (loadingState) loadingState.classList.add('hidden');
                
                updateStatistics();
                renderTransactions();
                updateLimitDisplay();
                updateStatus('loaded');
                
            } catch (error) {
                console.error('Error loading all:', error);
                
                const loadingState = document.getElementById('loading-state');
                const errorState = document.getElementById('error-state');
                
                if (loadingState) loadingState.classList.add('hidden');
                if (errorState) {
                    errorState.classList.remove('hidden');
                    const errorMsg = errorState.querySelector('p.text-gray-400');
                    if (errorMsg) {
                        errorMsg.textContent = `Failed to load all transactions: ${error.message}`;
                    }
                }
                
                updateStatus('error');
            }
        }

        // Refresh history
        function refreshHistory() {
            currentLimit = CONFIG.INITIAL_LIMIT;
            currentFilter = 'all';
            searchActive = false;
            searchResults = [];
            document.getElementById('search-input').value = '';
            document.getElementById('search-results-count').textContent = '';
            loadHistory();
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadHistory();
        });
    </script>

</body>
</html>
