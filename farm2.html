<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="config.js"></script>
    <script src="./priceMatrix.js"></script>
    <script src="skript.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Checking priceMatrixlocal:", window.priceMatrixlocal);
        });
    </script>
    <link rel="stylesheet" href="styles.css">

    <title>HashSense Farm</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e6e6e6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
        }
        .main-container {
            width: 100%;
            max-width: 100%;
            background-color: #2a2a2a;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .header {
            background-color: #444;
            padding: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 20px 20px 0 0;
        }
        .content {
            padding: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 20px;
            width: 150px;
            height: 150px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid #555;
        }
        .card-label {
            position: absolute;
            top: -15px;
            left: 10px;
            background-color: #673dec;
            z-index: 1;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.9em;
            border: 1px solid #555;
        }
        .farm-card {
            background-color: #333;
            padding: 20px;
            border-radius: 20px;
            flex-direction: column;
            width: 100%;
            text-align: center;
            margin: 20px auto 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            border: 1px solid #555;
            position: relative;
        }
        .input-container, .input-container-farm {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-top: 10px;
        }
        .input-container label, .input-container-farm label {
            font-size: 0.9em;
            color: #e6e6e6;
            margin-bottom: 3px;
        }
        .input-container input, .input-container-farm input {
            width: 100%;
            padding: 5px;
            border-radius: 10px;
            border: 1px solid #555;
            background-color: #2a2a2a;
            color: #e6e6e6;
            font-size: 1em;
            text-align: center;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: transparent;
            color: #e6e6e6;
            border: none;
            cursor: pointer;
            font-size: 20px;
            line-height: 20px;
            text-align: center;
        }
        .copy-btn {
            position: absolute;
            top: 7px;
            right: 25px;
            background-color: transparent;
            color: #e6e6e6;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .copy-btn:hover {
            color: #673dec;
        }
        .add-card {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            color: #e6e6e6;
            cursor: pointer;
            background-color: #444; /* Etwas heller als die normalen Cards */
            border: 2px dashed #673dec; /* Umrandung als Hinweis */
        }
        
        .add-card:hover {
            border-color: #9333ea;
            color: #9333ea;
        }
        .view-btn {
            background-color: #444;
            border: 2px solid #555;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        
        .view-btn.active {
            background-color: #9333ea;
            border-color: #673dec;
            transform: scale(1.1);
        }
        #currencySwitcher {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .currency-btn {
            background-color: #444;
            border: 2px solid #555;
            padding: 8px;
            margin: 5px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            color: #e6e6e6;
        }

        .currency-btn.active {
            background-color: #9333ea;
            border-color: #673dec;
            transform: scale(1.1);
        }


    </style>
</head>
<body>

    <div class="main-container">
        <div class="main-container">
            <header class="header">
                <div class="header-item">
                    <img src="https://github.com/Cimera311/Gomining_Calculator/raw/main/Bitcoin.svg.png" alt="BTC">
                    <select id="bitcoin-price-dropdown" onchange="updateBTCPrice();">
                        <option value="10000">10,000 $</option>
                        <option value="20000">20,000 $</option>
                        <option value="30000">30,000 $</option>    
                        <option value="40000">40,000 $</option>
                        <option value="50000">50,000 $</option>
                        <option value="60000">60,000 $</option>   
                        <option value="70000">70,000 $</option>
                        <option value="80000">80,000 $</option>
                        <option value="90000">90,000 $</option>
                        <option id="currentp" value="0">current price</option>
                        <option value="100000">100,000 $</option>
                        <option value="110000">110,000 $</option>
                        <option value="120000">120,000 $</option>
                        <option value="130000">130,000 $</option>
                        <option value="140000">140,000 $</option>
                        <option value="150000">150,000 $</option>
                        <option value="160000">160,000 $</option>
                        <option value="200000">200,000 $</option>
                        <option value="250000">250,000 $</option>
                        <option value="300000">300,000 $</option>
                        <option value="400000">400,000 $</option>   
                    </select>
                </div>
                <div class="header-item">
                    <img src="https://github.com/Cimera311/Gomining_Calculator/raw/main/GoMining_Logo.webp" alt="GMT">
                    <input value="0.400" id="gmt-token-price" placeholder="0,400">
                </div>
                <div class="header-item">
                    <label title="how much Satoshi Gomining pays for 1 TH" for="sat-TH">sat per TH:</label>
                    <input value="58" id="sat-TH">
                </div>
                <div class="header-item">
                    <button class="circular-button" onclick="fetchBTCPrice();fetchGMTPrice();">&#x21BB;</button>
                </div>
            </header>
        </div>
        <div class="main-container">
            <button onclick="hinzufuegenCard(get_highest_card(document.querySelector('.content')), '1', '20');">add miner</button>
                
                <button onclick="speichernDaten()">Save</button>
                <button onclick="ladenDaten()">Load</button>
                <button onclick="speichernMinerSupabase()">üíæ Save to Cloud</button>
                <button onclick="ladenMinerSupabase()">‚òÅÔ∏è Load from Cloud</button>
                <button onclick="loescheMinerSupabase()">üóëÔ∏è Delete from Cloud</button>

                <div id="viewSwitcher">
                    <button class="view-btn active" id="grid-btn" onclick="wechselAnsicht('grid')">üî≤ Grid</button>
                    <button class="view-btn" id="list-btn" onclick="wechselAnsicht('list')">üìã Liste</button>
                </div>
                <div id="currencySwitcher">
                    <button class="currency-btn" id="btc-btn" onclick="wechselWaehrung('btc')">‚Çø BTC</button>
                    <button class="currency-btn active" id="usd-btn" onclick="wechselWaehrung('usd')">$ USD</button>
                    <button class="currency-btn" id="gmt-btn" onclick="wechselWaehrung('gmt')">ü™ô GMT</button>
                </div>

                <!-- Unsichtbares Element zur Speicherung der aktiven W√§hrung -->
                <span id="currencyMode" style="display: none;">usd</span>
                <span id="viewMode" style="display: none;">grid</span>

           
        </div>
<div class="main-container">

<div class="content" id="farm-content">


</div>

        <div class="content" id="content"></div>


        </div>
    </div>
    </div>
</body>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm';

    const supabaseUrl = "https://umlgbacgghrvzwfvirro.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtbGdiYWNnZ2hydnp3ZnZpcnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MTAzMjQsImV4cCI6MjA1MjA4NjMyNH0.Hv0X4Wy4PtbSJ4yEN-CFszdX4zEoW4CMEHrbRBbX1Ug";

    // Supabase-Client erstellen und global verf√ºgbar machen
    window.supabase = createClient(supabaseUrl, supabaseKey);

    // Session abrufen
    const session = JSON.parse(sessionStorage.getItem("supabaseSession"));

    if (session) {
        window.supabase.auth.setSession(session);
        console.log("Supabase-Session in farm2.html geladen:", session);
    } else {
        console.error("Keine Supabase-Session gefunden. Weiterleitung zur Login-Seite...");
        window.location.href = "login.html";
    }
</script>

<script>
          const efficiencyMatrixfarm = {
                16: { to: 15, pricePerW: 1.32 },
                17: { to: 16, pricePerW: 1.32 },
                18: { to: 17, pricePerW: 1.32 },
                19: { to: 18, pricePerW: 1.32 },
                20: { to: 19, pricePerW: 1.32 },
                21: { to: 20, pricePerW: 0.75 },
                22: { to: 21, pricePerW: 0.75 },
                23: { to: 22, pricePerW: 0.75 },
                24: { to: 23, pricePerW: 0.75 },
                25: { to: 24, pricePerW: 0.75 },
                26: { to: 25, pricePerW: 0.75 },
                27: { to: 26, pricePerW: 0.75 },
                28: { to: 27, pricePerW: 0.75 },
                29: { to: 28, pricePerW: 0.99 },
                30: { to: 29, pricePerW: 0.99 },
                31: { to: 30, pricePerW: 0.99 },
                32: { to: 31, pricePerW: 0.99 },
                33: { to: 32, pricePerW: 0.99 },
                34: { to: 33, pricePerW: 0.99 },
                35: { to: 34, pricePerW: 0.99 },
                36: { to: 35, pricePerW: 0.27 },
                37: { to: 36, pricePerW: 0.27 },
                38: { to: 37, pricePerW: 0.27 },
                39: { to: 38, pricePerW: 0.27 },
                40: { to: 39, pricePerW: 0.27 },
                41: { to: 40, pricePerW: 0.27 },
                42: { to: 41, pricePerW: 0.27 },
                43: { to: 42, pricePerW: 0.27 },
                44: { to: 43, pricePerW: 0.27 },
                45: { to: 44, pricePerW: 0.27 },
                46: { to: 45, pricePerW: 0.27 },
                47: { to: 46, pricePerW: 0.27 },
                48: { to: 47, pricePerW: 0.27 },
                49: { to: 48, pricePerW: 0.27 },
                50: { to: 49, pricePerW: 0.27 }
            };

   
    function hinzufuegenCard(cardId, power, efficiency) {
    // Zugriff auf das Content-Element
    let content = document.querySelector('.content');

    // Erstelle die neue Card
    let card = document.createElement('div');
    card.className = 'card';
    card.id = cardId;

    // Card-Label hinzuf√ºgen
    let label = document.createElement('span');
    label.className = 'card-label';
    label.innerText = `#${cardId}`;
    card.appendChild(label);

    let deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '&times;';
    deleteBtn.onclick = function() {
        entfernenCard(cardId);
        loescheEinzelnenMinerSupabase(cardId)
    };
    card.appendChild(deleteBtn);
    let copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.innerHTML = '&#x2398;';
    copyBtn.onclick = function() {
        kopiereWerte(cardId);
    };
    card.appendChild(copyBtn);

    // Power Input mit Label
    let powerContainer = document.createElement('div');
    powerContainer.className = 'input-container';

    let powerLabel = document.createElement('label');
    powerLabel.setAttribute('for', `${cardId}-power`);
    powerLabel.innerText = 'Power';

    let powerInput = document.createElement('input');
    powerInput.type = 'text';
    powerInput.id = `${cardId}-power`;
    powerInput.value = `${power}`;
    powerInput.oninput = function() { aktualisiereWert(cardId, 'power'); aktualisiereFarmWerte(); };

    powerContainer.appendChild(powerLabel);
    powerContainer.appendChild(powerInput);
    card.appendChild(powerContainer);

    // Efficiency Input mit Label
    let efficiencyContainer = document.createElement('div');
    efficiencyContainer.className = 'input-container';

    let efficiencyLabel = document.createElement('label');
    efficiencyLabel.setAttribute('for', `${cardId}-efficiency`);
    efficiencyLabel.innerText = 'Efficiency';

    let efficiencyInput = document.createElement('input');
    efficiencyInput.type = 'text';
    efficiencyInput.id = `${cardId}-efficiency`;
    efficiencyInput.value = `${efficiency}`;
    efficiencyInput.oninput = function() { aktualisiereWert(cardId, 'efficiency'); aktualisiereFarmWerte();};

    efficiencyContainer.appendChild(efficiencyLabel);
    efficiencyContainer.appendChild(efficiencyInput);
    card.appendChild(efficiencyContainer);

    // Card zur Content-Sektion hinzuf√ºgen
    content.appendChild(card);
    aktualisiereFarmWerte();

}
function entfernenCard(cardId) {
    let card = document.getElementById(cardId);
    if (card) {
        card.remove();
    } else {
        console.warn(`Card mit ID ${cardId} existiert nicht.`);
    }
    aktualisiereFarmWerte();

}
function get_highest_card(content) {
    let highestId = 0;
    let cards = content.querySelectorAll('.card');

    cards.forEach(card => {
        let cardId = parseInt(card.id, 10);
        if (!isNaN(cardId) && cardId > highestId) {
            highestId = cardId;
        }
    });

    return String(highestId + 1).padStart(5, '0'); // R√ºckgabe als f√ºnfstellige Zahl
}
function speichernDaten() {
    let viewElement = document.getElementById('viewMode');
    let ansicht = viewElement.innerText; // Holt den aktuellen Modus aus der UI
    let minerData = [];

    if (ansicht === 'grid') {
        // **1Ô∏è‚É£ Alle Cards auslesen und speichern**
        let cards = document.getElementsByClassName('card');
        for (let i = 0; i < cards.length; i++) {
            let cardId = cards[i].id;
            let powerElement = document.getElementById(`${cardId}-power`);
            let efficiencyElement = document.getElementById(`${cardId}-efficiency`);

            if (powerElement && efficiencyElement) {
                minerData.push({
                    miner_id: cardId,
                    power: parseFloat(powerElement.value) || 0, // Jetzt wird es als Zahl gespeichert
                    efficiency: parseFloat(efficiencyElement.value) || 0
                });
            }
        }
    } else if (ansicht === 'list') {
        // **2Ô∏è‚É£ Falls die Tabelle aktiv ist, Daten aus Tabelle speichern**
        let rows = document.getElementById('miner-tbody').getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            let cells = rows[i].getElementsByTagName('td');
            minerData.push({
                miner_id: cells[0].innerText,
                power: cells[1].innerText.replace(' TH', ''), // "TH" entfernen
                efficiency: cells[2].innerText.replace(' W/TH', '') // "W/TH" entfernen
            });
        }
    }

    // **3Ô∏è‚É£ Miner-Daten in LocalStorage unter "minerData" speichern**
    localStorage.setItem('minerData', JSON.stringify(minerData));
}

function ladenDaten() {
    let viewElement = document.getElementById('viewMode');
    let ansicht = viewElement.innerText; // Holt den aktuellen Modus aus der UI

    let savedData = localStorage.getItem('minerData');
    if (!savedData) return; // Falls keine Daten existieren, nichts tun

    let minerData = JSON.parse(savedData);
    
    // Ansicht abh√§ngig vom gespeicherten Modus laden
    let content = document.getElementById('content');
    let table = document.getElementById('miner-table');
    if (table) table.remove(); // Falls eine Tabelle existiert, l√∂schen

    // Ansicht abh√§ngig vom gespeicherten Modus laden
    let contentfarm = document.getElementById('farm-content');
    let tablefarm = document.getElementById('farm-table');
    if (tablefarm) tablefarm.remove(); // Falls eine Tabelle existiert, l√∂schen


    let cardsfarm = document.getElementsByClassName('farm-card');
    for (let i = cardsfarm.length - 1; i >= 0; i--) {
        cardsfarm[i].remove();
    }
    let cards = document.getElementsByClassName('card');
    for (let i = cards.length - 1; i >= 0; i--) {
        cards[i].remove();
    }



    // **Zuerst Farm laden (entweder als Card oder als Tabelle)**
    if (ansicht === 'grid') {
        ladeFarmCard(minerData); // Farm als Card laden
    } else {
        ladeFarmTable(minerData); // Farm als Tabelle laden
    }
    if (ansicht === 'grid') {
        // Miner als Cards hinzuf√ºgen

        minerData.forEach(miner => {
            hinzufuegenCard(miner.miner_id, miner.power, miner.efficiency);
        });

    } else if (ansicht === 'list') {
        // Erstelle eine Tabelle

        let tableElement = document.createElement('table');
        tableElement.id = 'miner-table';

        let thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>ID</th>
                <th>TH</th>
                <th>W/TH</th>
                <th>ROI +1 TH(%)</th>
                <th>ROI -1 W/TH(%)</th>
                <th>revenue</th>
                <th>electricity</th>
                <th>service</th>
                <th>profit</th>
            </tr>
        `;
        tableElement.appendChild(thead);

        let tbody = document.createElement('tbody');
        tbody.id = 'miner-tbody';
        tableElement.appendChild(tbody);

        content.appendChild(tableElement);

        ladenMinerInTabelle();
    }
}
function ladeFarmTable(minerData) {
    let farmContent = document.getElementById('farm-content');
    if (!farmContent) {
        console.error("Fehler: #farm-content nicht gefunden.");
        return;
    }

    // Falls bereits eine Farm-Tabelle existiert, entfernen wir sie
    let existingTable = document.getElementById('farm-table');
    if (existingTable) {
        existingTable.remove();
    }

    // Neue Farm-Tabelle erstellen
    let tableElement = document.createElement('table');
    tableElement.id = 'farm-table';

    // Tabellenkopf hinzuf√ºgen
    let thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Power (TH)</th>
            <th>Efficiency (W/TH)</th>
            <th>My Total discount(%)</th>
            <th>revenue</th>
            <th>electricity</th>
            <th>service</th>
            <th>profit</th>
        </tr>
    `;
    tableElement.appendChild(thead);

    // Tabellenk√∂rper hinzuf√ºgen
    let tbody = document.createElement('tbody');

    // Berechnung der Gesamtwerte f√ºr die Farm
    let totalPower = 0;
    let weightedEfficiencySum = 0;
    let btcPrice = parseFloat(document.getElementById('bitcoin-price-dropdown').value) || 0;
    let gmtPrice = parseFloat(document.getElementById('gmt-token-price').value) || 0;
    let satoshiPerTH = parseFloat(document.getElementById('sat-TH').value) || 0;
    // Aktuelle W√§hrung auslesen
    let currencyElement = document.getElementById('currencyMode');
    let waehrung = currencyElement.innerText; // btc, usd oder gmt
    minerData.forEach(miner => {
        let power = parseFloat(miner.power) || 0;
        let efficiency = parseFloat(miner.efficiency) || 0;
        totalPower += power;
        weightedEfficiencySum += (power * efficiency);
    });
    let user_data = localStorage.getItem('user_data');
    let avgEfficiency = totalPower > 0 ? (weightedEfficiencySum / totalPower).toFixed(2) : 0;
    let revenue = calculateDailyRevenue(satoshiPerTH, totalPower, btcPrice, gmtPrice, avgEfficiency);
    let dailyelectricity = calculateDailyElectricity(totalPower, avgEfficiency, btcPrice, gmtPrice);
    let dailyservice = calculateDailyService(totalPower, btcPrice, gmtPrice)


        //let roiEff = calculateROI_EfficiencyUpgrade(miner.efficiency, miner.efficiency - 5, miner.power);
        let profitbtc = revenue.btc - dailyelectricity.btc - dailyservice.btc;
        let revenueDisplay = '';
        if (waehrung === 'btc') {
            revenueDisplay = `${revenue.btc.toFixed(8)} BTC`;
            electricityDisplay = `${dailyelectricity.btc.toFixed(8)} BTC`;
            serviceDisplay = `${dailyservice.btc.toFixed(8)} BTC`;
            profitDisplay = `${profitbtc.toFixed(8)} BTC`;
        } else if (waehrung === 'usd') {
            revenueDisplay = `$${revenue.usd.toFixed(2)}`;
            electricityDisplay = `$${dailyelectricity.usd.toFixed(2)}`;
            serviceDisplay = `$${dailyservice.usd.toFixed(2)} `;
            let profit = btc2usd(btcPrice, profitbtc);
            profitDisplay = `$${profit} `;
        } else if (waehrung === 'gmt') {
            revenueDisplay = `${revenue.gmt ? revenue.gmt.toFixed(2) : "N/A"} GMT`;
            electricityDisplay = `${dailyelectricity.gmt.toFixed(2)} GMT`;
            serviceDisplay = `${dailyservice.gmt.toFixed(2)} GMT`;
            let profit = btc2gmt(btcPrice, gmtPrice, profitbtc);
            profitDisplay = `${profit} GMT`;
        }
        let row = document.createElement('tr');
        row.innerHTML = `
            <td>${totalPower}</td>
            <td>${avgEfficiency}</td>
            <th>${user_data.total_discount}</th>
            <td>${revenueDisplay}</td>
            <td>${electricityDisplay}</td>
            <td>${serviceDisplay}</td>
            <td>${profitDisplay}</td>
        `;
    tbody.appendChild(row);
    tableElement.appendChild(tbody);

    // Tabelle in den Farm-Content einf√ºgen
    farmContent.appendChild(tableElement);
}
function ladeFarmCard(minerData) {
    let farmContent = document.getElementById('farm-content');
    if (!farmContent) {
        console.error("Fehler: #farm-content nicht gefunden.");
        return;
    }

    // Falls eine bestehende Farm-Card existiert, entfernen
    let existingFarm = document.getElementById('farm');
    if (existingFarm) {
        existingFarm.remove();
    }

    // Neue Farm-Card erstellen
    let farmCard = document.createElement('div');
    farmCard.className = 'farm-card';
    farmCard.id = 'farm';

    // Farm-Label und Delete-Button
    farmCard.innerHTML = `
        <button class="delete-btn" onclick="entfernenFarm()">&times;</button>
        <span class="card-label">Farm</span>
    `;

    // Farm-Gesamtwerte berechnen
    let totalPower = 0;
    let weightedEfficiencySum = 0;
    let user_data = localStorage.getItem('user_data');
    minerData.forEach(miner => {
        let power = parseFloat(miner.power) || 0;
        let efficiency = parseFloat(miner.efficiency) || 0;
        totalPower += power;
        weightedEfficiencySum += (power * efficiency);
    });

    let avgEfficiency = totalPower > 0 ? (weightedEfficiencySum / totalPower).toFixed(2) : 0;

    // Input-Felder f√ºr Power & Efficiency
    farmCard.innerHTML += `
        <div class="input-container-farm">
            <label for="farm-power">Power</label>
            <input type="text" id="farm-power" value="${totalPower.toFixed(2)}" oninput="aktualisiereWert('farm', 'power')">
        </div>   
        <div class="input-container-farm">
            <label for="farm-efficiency">Efficiency</label>
            <input type="text" id="farm-efficiency" value="${avgEfficiency}" oninput="aktualisiereWert('farm', 'efficiency')">
        </div>
          <div class="input-container-farm">
        <label for="gomining-discount">My total Discount (%):</label>
            <input type="number" id="gomining-discount" value="${user_data.total_discount}" min="0" max="20" placeholder="0,0">
        </div>      

    `;

    // Farm-Card in farm-content einf√ºgen
    farmContent.appendChild(farmCard);
}


function ladenMinerInTabelle() {
    let minerData = JSON.parse(localStorage.getItem('minerData')) || [];
    let tbody = document.getElementById('miner-tbody');
    
    // Aktuelle W√§hrung auslesen
    let currencyElement = document.getElementById('currencyMode');
    let waehrung = currencyElement.innerText; // btc, usd oder gmt
    
    // **1Ô∏è‚É£ Fehlende Variablen aus UI abrufen**
    let satoshiPerTH = parseFloat(document.getElementById('sat-TH').value) || 0; // Satoshi pro TH
    let btcPrice = parseFloat(document.getElementById('bitcoin-price-dropdown').value) || 0; // BTC-Preis
    let gmtPrice = parseFloat(document.getElementById('gmt-token-price').value) || 0; // GMT-Token-Preis

    
    tbody.innerHTML = ''; // Leere Tabelle vor dem Neuladen

    minerData.forEach(miner => {
        let myTH = parseFloat(miner.power) ? parseFloat(miner.power) : 0; // Miner-TH aus `minerData`
        let efficiency = parseFloat(miner.efficiency) || 0; // Effizienz aus `minerData`
        let revenue = calculateDailyRevenue(satoshiPerTH, myTH, btcPrice, gmtPrice, efficiency);
        let revenueupgrade = calculateDailyRevenue(satoshiPerTH, 1, btcPrice, gmtPrice, efficiency);
        let dailyelectricity = calculateDailyElectricity(miner.power, miner.efficiency, btcPrice, gmtPrice)
        let dailyservice = calculateDailyService(miner.power, btcPrice, gmtPrice)
        let roiTH;
        if (miner.efficiency <= 28) {
            roiTH = calculateROI_THUpgrade(miner.power, 1, getPricePerTH(efficiency, myTH), revenueupgrade, efficiency);
        } else {
            roiTH = '0';
        }
        let roiWATT;
        if (miner.efficiency <= 50) {
            roiWATT = ROIofWATTUpgrade(getUpgradeCostWATT(efficiency, efficiency -1 , myTH), myTH, efficiency, efficiency-1) ;
        } else {
            roiWATT.roi_percent = '0';            
            roiWATT.profit_increase.btc = 0;
            roiWATT.profit_increase.usd = 0;
            roiWATT.profit_increase.gmt = 0;
        }

        //let roiEff = calculateROI_EfficiencyUpgrade(miner.efficiency, miner.efficiency - 5, miner.power);
        let profitbtc = revenue.btc - dailyelectricity.btc - dailyservice.btc;
        let revenueDisplay = '';
        let plusTHprofit = 0;
        let plusWATTprofit = 0;
        if (waehrung === 'btc') {
            revenueDisplay = `${revenue.btc.toFixed(8)} BTC`;
            electricityDisplay = `${dailyelectricity.btc.toFixed(8)} BTC`;
            serviceDisplay = `${dailyservice.btc.toFixed(8)} BTC`;
            profitDisplay = `${profitbtc.toFixed(8)} BTC`;
            plusWATTprofit =  `${roiWATT.profit_increase.btc.toFixed(8)} BTC`;
        } else if (waehrung === 'usd') {
            revenueDisplay = `$${revenue.usd.toFixed(2)}`;
            electricityDisplay = `$${dailyelectricity.usd.toFixed(2)}`;
            serviceDisplay = `$${dailyservice.usd.toFixed(2)} `;
            let profit = btc2usd(btcPrice, profitbtc);
            profitDisplay = `$${profit} `;
            plusWATTprofit =  `$${roiWATT.profit_increase.usd}`;
        } else if (waehrung === 'gmt') {
            revenueDisplay = `${revenue.gmt ? revenue.gmt.toFixed(2) : "N/A"} GMT`;
            electricityDisplay = `${dailyelectricity.gmt.toFixed(2)} GMT`;
            serviceDisplay = `${dailyservice.gmt.toFixed(2)} GMT`;
            let profit = btc2gmt(btcPrice, gmtPrice, profitbtc);
            profitDisplay = `${profit} GMT`;
            plusWATTprofit =  `${roiWATT.profit_increase.gmt} GMT`;
        }
        let row = document.createElement('tr');
        row.innerHTML = `
            <td>${miner.miner_id}</td>
            <td>${miner.power}</td>
            <td>${miner.efficiency}</td>
            <td>${roiTH}%</td>
            <td>${roiWATT.roi_percent}% <span style="color: green;">(+${plusWATTprofit})</span></td>
            <td>${revenueDisplay}</td>
            <td>${electricityDisplay}</td>
            <td>${serviceDisplay}</td>
            <td>${profitDisplay}</td>
        `;
        tbody.appendChild(row);
    });
}




// Seite initialisieren
window.onload = function() {
    ladenDaten();
    aktualisiereFarmWerte();

};

let ansicht = 'grid';


function aktualisiereWert(cardId, feld) {
    let inputElement = document.getElementById(`${cardId}-${feld}`);
    if (inputElement) {
        let gespeicherteCards = JSON.parse(localStorage.getItem('cards')) || [];
        
        // Finde die richtige Karte und aktualisiere den Wert
        gespeicherteCards.forEach(card => {
            if (card.id === cardId) {
                card[feld] = inputElement.value;
            }
        });

        // Aktualisierte Werte speichern
        localStorage.setItem('cards', JSON.stringify(gespeicherteCards));


    }
}
function entfernenFarm() {
    let content = document.querySelector('.content');
    content.innerHTML = '';
    aktualisiereFarmWerte();

}
function aktualisiereFarmWerte() {
    let content = document.querySelector('.content');
    let cards = content.querySelectorAll('.card');
    
    let totalPower = 0;
    let totalEfficiency = 0;
    let count = 0;

    cards.forEach(card => {
        let powerElement = document.getElementById(`${card.id}-power`);
        let efficiencyElement = document.getElementById(`${card.id}-efficiency`);


        if (powerElement && efficiencyElement) {
            let powerValue = parseFloat(powerElement.value) || 0;
            let efficiencyValue = parseFloat(efficiencyElement.value) || 0;

            totalPower += powerValue;
            totalEfficiency += ( powerValue * efficiencyValue );
            count++;
        }
    });

        let avgEfficiency = count > 0 ? (totalEfficiency / totalPower).toFixed(2) : 0;

        document.getElementById('farm-power').value = totalPower.toFixed(2);
        document.getElementById('farm-efficiency').value = avgEfficiency;
    }

    function kopiereWerte(cardId) {
        let powerValue = document.getElementById(`${cardId}-power`).value;
        let efficiencyValue = document.getElementById(`${cardId}-efficiency`).value;
        hinzufuegenCard(get_highest_card(document.querySelector('.content')), powerValue, efficiencyValue)
   

    }
function wechselAnsicht(mode) {
    speichernDaten(); // Speichert die aktuellen Miner-Daten
    let viewElement = document.getElementById('viewMode');
    viewElement.innerText = mode; // Speichert den aktuellen Modus in HTML

    // Entferne vorherige aktive Markierung
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));

    // Setze den aktiven Button basierend auf der gew√§hlten Ansicht
    document.getElementById(`${mode}-btn`).classList.add('active');
    ladenDaten(); // L√§dt die Daten f√ºr die neue Ansicht
}





function calculateROI_THUpgrade(power, additionalTH, pricePerTH, dailyRevenuePerTH, minerefficency) {
    let btcPrice = parseFloat(document.getElementById('bitcoin-price-dropdown').value) || 0; // BTC-Preis
    let gmtPrice = parseFloat(document.getElementById('gmt-token-price').value) || 0; // GMT-Token-Preis
    let upgradeCost = additionalTH * pricePerTH; // Gesamtkosten f√ºr das Upgrade
    let additionalDailyRevenuebtc = additionalTH * dailyRevenuePerTH.btc; // Zus√§tzlicher t√§glicher Ertrag in BTC
    let dailyelectricity = calculateDailyElectricity(additionalTH, minerefficency, btcPrice, gmtPrice)
    let dailyservice = calculateDailyService(additionalTH, btcPrice, gmtPrice)
    let dailyProfitbtc = additionalDailyRevenuebtc - dailyelectricity.btc - dailyservice.btc
    let dailyProfit = btc2usd(btcPrice, dailyProfitbtc);
    let upgradecostbtc = usd2btc(upgradeCost ,btcPrice );
    let roiDays = upgradecostbtc / dailyProfitbtc // ROI in Tagen
    let roiPercent = (365 / roiDays) * 100; // ROI in %

    return roiPercent.toFixed(2); // R√ºckgabe als Prozentwert
}


// Berechnet den zus√§tzlichen Profit durch ein TH-Upgrade
function calculateProfitIncreaseTH(amountTH) {
    let satoshiPerTH = parseFloat(document.getElementById('sat-TH').value) || 0;
    let moreSatoshi = satoshiPerTH * amountTH;
    return moreSatoshi; // Da der Profit pro TH bereits definiert ist
}

// Berechnet den zus√§tzlichen Profit durch ein Effizienz-Upgrade
function calculateProfitIncreaseEfficiency(currentTH, currentEfficiency, newEfficiency) {
    let satoshiPerTH = parseFloat(document.getElementById('sat-TH').value) || 0;
    let btcPrice = parseFloat(document.getElementById('bitcoin-price-dropdown').value) || 0;
    let gmtPrice = parseFloat(document.getElementById('gmt-token-price').value) || 0;

    let currentRevenue = calculateDailyRevenue(satoshiPerTH, currentTH, btcPrice, gmtPrice);
    let currentElectricity = calculateDailyElectricity(currentTH, currentEfficiency, btcPrice, gmtPrice);
    let currentService = calculateDailyService(currentTH, btcPrice, gmtPrice);
    let currentProfitBTC = currentRevenue.btc - currentElectricity.btc - currentService.btc;

    let newRevenue = calculateDailyRevenue(satoshiPerTH, currentTH, btcPrice, gmtPrice);
    let newElectricity = calculateDailyElectricity(currentTH, newEfficiency, btcPrice, gmtPrice);
    let newService = calculateDailyService(currentTH, btcPrice, gmtPrice);
    let newProfitBTC = newRevenue.btc - newElectricity.btc - newService.btc;

    return {
        btc: newProfitBTC - currentProfitBTC,
        usd: btc2usd(btcPrice, newProfitBTC - currentProfitBTC),
        gmt: btc2gmt(btcPrice, gmtPrice, newProfitBTC - currentProfitBTC)
    };
}

// Berechnet das ROI eines Upgrades basierend auf den Investitionskosten und dem zus√§tzlichen Profit
function ROIofWATTUpgrade(upgradeCost, currentTH, currentEfficiency, newEfficiency) {
    let profitIncrease = calculateProfitIncreaseEfficiency(currentTH, currentEfficiency, newEfficiency);
    let btcPrice = parseFloat(document.getElementById('bitcoin-price-dropdown').value) || 0;

    if (profitIncrease.btc <= 0) {
        return "‚àû"; // Falls das Upgrade keinen positiven Profit generiert
    }
    let upgradeCostBTC = usd2btc(upgradeCost, btcPrice);
    let roiDays = upgradeCostBTC / profitIncrease.btc;
    let roiPercent = (365 / roiDays) * 100; // ROI in %

    return {
        roi_percent: roiPercent.toFixed(2), // R√ºckgabe als Prozentwert
        profit_increase: profitIncrease        }
            }

// Berechnet die Gesamtkosten f√ºr ein Effizienz-Upgrade √ºber mehrere Stufen
function getUpgradeCostWATT(currentEfficiency, newEfficiency, currentTH) {
    let totalCost = 0;

    // Sicherstellen, dass die Werte korrekt eingegeben sind
    if (currentEfficiency <= newEfficiency) {
        console.error("Upgrade nicht m√∂glich: newEfficiency muss kleiner als currentEfficiency sein.");
        return totalCost;
    }

    let efficiency = currentEfficiency; // Startwert

    while (efficiency > newEfficiency) {
        if (efficiencyMatrixfarm[efficiency]) {
            let costPerW = efficiencyMatrixfarm[efficiency].pricePerW;
            let nextEfficiency = efficiencyMatrixfarm[efficiency].to;
            let efficiencyStep = efficiency - nextEfficiency;
            totalCost += costPerW * efficiencyStep * currentTH;
            efficiency = nextEfficiency; // N√§chstes Effizienz-Level setzen
        } else {
            console.error(`Kein Eintrag f√ºr Effizienz ${efficiency} in efficiencyMatrixfarm gefunden.`);
            break;
        }
    }

    return totalCost.toFixed(2); // R√ºckgabe der gesamten Upgrade-Kosten
}





function getEfficiencyUpgradePrice(currentEfficiency) {
    if (efficiencyMatrixfarm[currentEfficiency]) {
        return efficiencyMatrixfarm[currentEfficiency].pricePerW;
    }
    return null; // Falls keine Daten vorhanden sind
}
function getPricePerTH(efficiency, thAmount) {
    if (!priceMatrixdatei[efficiency]) {
        console.error(`Keine Preisdaten f√ºr ${efficiency} W/TH gefunden.`);
        return null;
    }

    let priceEntries = priceMatrixdatei[efficiency];

    // Finde den passenden Preis f√ºr die gegebene TH-Menge
    for (let i = priceEntries.length - 1; i >= 0; i--) {
        if (thAmount >= priceEntries[i].minTH) {
            return priceEntries[i].pricePerTH;
        }
    }

    return null; // Falls keine passende Preisstufe gefunden wurde
}
function wechselWaehrung(mode) {
    let currencyElement = document.getElementById('currencyMode');
    currencyElement.innerText = mode; // Speichert die W√§hrung im UI

    // Entferne vorherige aktive Markierung
    document.querySelectorAll('.currency-btn').forEach(btn => btn.classList.remove('active'));

    // Setze den aktiven Button basierend auf der gew√§hlten W√§hrung
    let activeButton = document.getElementById(`${mode}-btn`);
    if (activeButton) {
        activeButton.classList.add('active');
    } else {
        console.error(`Fehler: Der Button ${mode}-btn existiert nicht.`);
    }

    // Aktualisiere die Miner-Tabelle mit der neuen W√§hrung
    speichernDaten();
    ladenDaten();
}

function btc2usd(btcPrice, valueBtc) {
    return (btcPrice * valueBtc).toFixed(2);
}
function usd2btc(usdValue, btcPrice) {
    return (usdValue / btcPrice).toFixed(8);
}
function btc2gmt(btcPrice, gmtPrice, valueBtc) {
    if (gmtPrice === 0 || isNaN(gmtPrice)) {
        console.error("Fehler: GMT-Preis ist 0 oder ung√ºltig.");
        return "N/A";
    }
    return ((btcPrice * valueBtc) / gmtPrice).toFixed(2);
}


                async function speichernMinerSupabase() {
                    speichernDaten();
                    const { data: user, error: userError } = await supabase.auth.getUser();
                    if (userError || !user) {
                        console.error("Fehler beim Abrufen des Benutzers:", userError);
                        return;
                    }
                
                    let userId = user.user.id; // Aktuelle User-ID
                    let minerData = JSON.parse(localStorage.getItem('minerData')) || [];
                    let user_data = JSON.parse(localStorage.getItem('user_data')) || [];              
                    // Bestehende Miner des Users in Supabase l√∂schen (optional)
                    await supabase.from('miners').delete().eq('user_id', userId);
                    await supabase.from('user_data').delete().eq('user_id', userId);    
                    
                    // Miner-Daten in Supabase speichern
                    let { data, error } = await supabase.from('miners').insert(
                        minerData.map(miner => ({
                            user_id: userId,
                            miner_id: miner.miner_id,
                            power: miner.power,
                            efficiency: miner.efficiency
                        }))
                       let { data, error } = await supabase.from('user_data').insert(
                        user_data.map(user_data => ({
                            user_id: userId,
                            total_discount: user_data.total_discount
                        }))
                    );
                
                    if (error) {
                        console.error("Fehler beim Speichern der Miner in Supabase:", error);
                        alert("Error while saving miners!");
                    } else {
                        console.log("Miner erfolgreich gespeichert:", data);
                        alert("All miners saved!");
                    }
                }
                async function ladenuserdataSupabase() {
                    const { data: user, error: userError } = await supabase.auth.getUser();
                    if (userError || !user) {
                        console.error("Fehler beim Abrufen des Benutzers:", userError);
                        return;
                    }
                
                    let userId = user.user.id;
                
                    let { data: user_data, error } = await supabase
                        .from('user_data')
                        .select('total_discount')
                        .eq('user_id', userId);
                
                    if (error) {
                        console.error("Fehler beim Laden der user_data aus Supabase:", error);
                        alert("Error loading user_data!");
                        user_data.total_discount = 0;
                        localStorage.setItem('user_data', JSON.stringify(user_data));
                        return;
                    }
                
                    // Miner in localStorage speichern und laden
                    localStorage.setItem('user_data', JSON.stringify(user_data));
                    alert("user_data loaded!");
                }
                async function ladenMinerSupabase() {
                    const { data: user, error: userError } = await supabase.auth.getUser();
                    if (userError || !user) {
                        console.error("Fehler beim Abrufen des Benutzers:", userError);
                        return;
                    }
                
                    let userId = user.user.id;
                
                    let { data: miners, error } = await supabase
                        .from('miners')
                        .select('miner_id, power, efficiency')
                        .eq('user_id', userId);
                
                    if (error) {
                        console.error("Fehler beim Laden der Miner aus Supabase:", error);
                        alert("Error loading miners!");
                        return;
                    }
                
                    // Miner in localStorage speichern und laden
                    localStorage.setItem('minerData', JSON.stringify(miners));
                    ladenuserdataSupabase()
                    ladenDaten(); // Miner in UI anzeigen
                    alert("All miners loaded!");
                }
                
                async function loescheMinerSupabase() {
                    const { data: user, error: userError } = await supabase.auth.getUser();
                    if (userError || !user) {
                        console.error("Fehler beim Abrufen des Benutzers:", userError);
                        return;
                    }
                
                    let userId = user.user.id;
                
                    let { error } = await supabase.from('miners').delete().eq('user_id', userId);
                
                    if (error) {
                        console.error("Fehler beim L√∂schen der Miner aus Supabase:", error);
                    } else {
                        console.log("Alle Miner des Nutzers wurden gel√∂scht.");
                        alert("All miners deleted!");
                    }
                }
                async function loescheEinzelnenMinerSupabase(minerIdloc) {
                    const { data: user, error: userError } = await supabase.auth.getUser();
                    if (userError || !user) {
                        console.error("Fehler beim Abrufen des Benutzers:", userError);
                        return;
                    }
                
                    let userId = user.user.id;
                
                    let { error } = await supabase
                        .from('miners')
                        .delete()
                        .match({ user_id: userId, miner_id: minerIdloc });
                
                    if (error) {
                        console.error(`Fehler beim L√∂schen des Miners mit ID ${minerIdloc}:`, error);
                        alert("Error deleting miner!");
                    } else {
                        console.log(`Miner mit ID ${minerIdloc} wurde gel√∂scht.`);
                        alert("Miner deleted!");
                    }
}


  </script>
</html>
