<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HashFarm Referral Organizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/+esm';

  const supabaseUrl = "https://umlgbacgghrvzwfvirro.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtbGdiYWNnZ2hydnp3ZnZpcnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MTAzMjQsImV4cCI6MjA1MjA4NjMyNH0.Hv0X4Wy4PtbSJ4yEN-CFszdX4zEoW4CMEHrbRBbX1Ug";

  // Supabase-Client erstellen und global verfÃ¼gbar machen
  window.supabase = createClient(supabaseUrl, supabaseKey);

  // Session abrufen
  const session = JSON.parse(sessionStorage.getItem("supabaseSession"));

  if (session) {
      window.supabase.auth.setSession(session);
      console.log("Supabase-Session in linkview.html geladen:", session);
  } else {
      console.error("Keine Supabase-Session gefunden. Weiterleitung zur Login-Seite...");
      window.location.href = "login.html";
  }
</script>

</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-6">

  <div class="w-full max-w-3xl">
    <h1 class="text-3xl font-bold mb-4 text-center">ðŸ”— HashFarm Referral Organizer</h1>

    <!-- Eingabefeld -->
    <div class="flex gap-2 mb-6">
      <input
        id="referralInput"
        type="url"
        placeholder="Paste your GoMining referral link hereâ€¦"
        class="flex-grow px-4 py-2 rounded bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
      <button
        id="addBtn"
        class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white font-semibold"
      >
        Add
      </button>
    </div>

    <!-- Cards -->
    <div id="cardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>

  <!-- Template -->
<template id="cardTemplate">
  <div class="group relative bg-gray-800 border border-gray-700 rounded-lg overflow-hidden shadow-lg transition hover:shadow-purple-500/50">

    <!-- X-Button -->
    <button class="absolute top-2 right-2 z-10 bg-black/60 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600 delete-btn">
      âœ•
    </button>

    <!-- Bildbereich -->
    <div class="w-full aspect-video bg-gray-700 flex items-center justify-center overflow-hidden">
      <img src="" alt="Preview" class="w-full h-full object-cover hidden" />
      <span class="text-xs text-gray-300">No image</span>
    </div>

    <!-- Textbereich -->
    <div class="p-4">
      <p class="text-sm font-semibold truncate"></p>
      <p class="text-xs text-gray-400 line-clamp-2"></p>
    </div>

    <!-- Overlay beim Kopieren -->
    <div class="absolute inset-0 bg-black/70 text-green-400 text-lg font-semibold flex items-center justify-center opacity-0 group-[.copied]:opacity-100 transition">
      âœ… Copied!
    </div>
  </div>
</template>


  <script>
    const FN_URL = "https://umlgbacgghrvzwfvirro.supabase.co/functions/v1/get-og";

    const input = document.getElementById("referralInput");
    const addBtn = document.getElementById("addBtn");
    const container = document.getElementById("cardsContainer");
    const tpl = document.getElementById("cardTemplate");

    addBtn.addEventListener("click", addReferralLink);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addReferralLink();
    });

    async function addReferralLink() {
      const url = (input.value || "").trim();
      if (!url) return;

      // Ladeanzeige
      const oldText = addBtn.textContent;
      addBtn.disabled = true;
      addBtn.textContent = "Fetchingâ€¦";

      try {
        const res = await fetch(FN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });
        const data = await res.json();

        if (!res.ok || !data?.success) {
          throw new Error(data?.error || "Failed to get OG data");
        }

        renderCard({
          url,
          title: data.ogTitle || "Referral Link",
          description: data.ogDescription || "",
          image: data.ogImage || null,
        });

        input.value = "";
      } catch (err) {
        alert("âŒ Fehler beim Laden der OG-Daten. Siehe Konsole.");
        console.error(err);
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = oldText;
      }
    }

function renderCard({ url, title, description, image }, id) {
  const node = tpl.content.cloneNode(true);
  const img = node.querySelector("img");
  const imgBox = node.querySelector(".w-full.aspect-video");
  const titleEl = node.querySelector("p.text-sm");
  const descEl = node.querySelector("p.text-xs");
  const cardEl = node.querySelector(".group");

  titleEl.textContent = title;
  descEl.textContent = description;

  if (image) {
    img.src = image;
    img.alt = title;
    img.classList.remove("hidden");
    imgBox.querySelector("span")?.classList.add("hidden");
  }

  // Copy on click (auÃŸer X)
  cardEl.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-btn")) return;
    navigator.clipboard.writeText(url);
    cardEl.classList.add("copied");
    setTimeout(() => cardEl.classList.remove("copied"), 900);
  });

  // Delete Button
  const deleteBtn = node.querySelector(".delete-btn");
  deleteBtn.addEventListener("click", async (e) => {
    e.stopPropagation();
    cardEl.remove();

    if (id) {
      const { error } = await supabase
        .from("referral_links")
        .delete()
        .eq("id", id);
      if (error) console.error("Error deleting link:", error);
    }
  });

  container.prepend(node);
}

async function loadUserLinks() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    console.log("Not logged in");
    return;
  }

  const { data, error } = await supabase
    .from("referral_links")
    .select("id, url")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading links:", error);
    return;
  }

  container.innerHTML = "";
  for (const link of data) {
    // OG-Daten live abrufen
    await addCardFromLink(link.url, link.id);
  }
}
const { data: { user } } = await supabase.auth.getUser();
if (user) {
  const { data: inserted, error } = await supabase
    .from("referral_links")
    .insert([{ user_id: user.id, url }])
    .select("id")
    .single();

  if (error) {
    console.error("Error saving link:", error);
  } else {
    renderCard({
      url,
      title: data.ogTitle || "Referral Link",
      description: data.ogDescription || "",
      image: data.ogImage || null,
    }, inserted.id);
  }
}

  </script>
</body>
</html>
