<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HashFarm Referral Organizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center p-6">

  <div class="w-full max-w-3xl">
    <h1 class="text-3xl font-bold mb-4 text-center">🔗 HashFarm Referral Organizer</h1>

    <!-- Eingabefeld -->
    <div class="flex gap-2 mb-6">
      <input
        id="referralInput"
        type="url"
        placeholder="Paste your GoMining referral link here…"
        class="flex-grow px-4 py-2 rounded bg-gray-800 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
      />
      <button
        id="addBtn"
        class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded text-white font-semibold"
      >
        Add
      </button>
    </div>

    <!-- Cards -->
    <div id="cardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>

  <!-- Template -->
  <template id="cardTemplate">
    <div class="w-full aspect-video bg-gray-700 flex items-center justify-center overflow-hidden">
      <img src="" alt="Preview" class="w-full h-full object-cover hidden" />
      <span class="text-xs text-gray-300">No image</span>
    </div>

      <div class="p-4">
        <p class="text-sm font-semibold truncate"></p>
        <p class="text-xs text-gray-400 line-clamp-2"></p>
      </div>
      <div class="absolute inset-0 bg-black bg-opacity-70 text-green-400 text-lg font-semibold flex items-center justify-center opacity-0 group-active:opacity-100 transition">
        ✅ Copied!
      </div>
    </div>
  </template>

  <script>
    const FN_URL = "https://umlgbacgghrvzwfvirro.supabase.co/functions/v1/get-og";

    const input = document.getElementById("referralInput");
    const addBtn = document.getElementById("addBtn");
    const container = document.getElementById("cardsContainer");
    const tpl = document.getElementById("cardTemplate");

    addBtn.addEventListener("click", addReferralLink);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addReferralLink();
    });

    async function addReferralLink() {
      const url = (input.value || "").trim();
      if (!url) return;

      // Ladeanzeige
      const oldText = addBtn.textContent;
      addBtn.disabled = true;
      addBtn.textContent = "Fetching…";

      try {
        const res = await fetch(FN_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });
        const data = await res.json();

        if (!res.ok || !data?.success) {
          throw new Error(data?.error || "Failed to get OG data");
        }

        renderCard({
          url,
          title: data.ogTitle || "Referral Link",
          description: data.ogDescription || "",
          image: data.ogImage || null,
        });

        input.value = "";
      } catch (err) {
        alert("❌ Fehler beim Laden der OG-Daten. Siehe Konsole.");
        console.error(err);
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = oldText;
      }
    }

    function renderCard({ url, title, description, image }) {
      const node = tpl.content.cloneNode(true);
      const img = node.querySelector("img");
      const imgBox = node.querySelector(".w-full.h-40");
      const titleEl = node.querySelector("p.text-sm");
      const descEl = node.querySelector("p.text-xs");
      const cardEl = node.querySelector(".group");

      titleEl.textContent = title;
      descEl.textContent = description;

      if (image) {
        img.src = image;
        img.alt = title;
        img.classList.remove("hidden");
        imgBox.querySelector("span")?.classList.add("hidden");
      }

      cardEl.addEventListener("click", () => {
        navigator.clipboard.writeText(url);
        const overlay = cardEl.querySelector(".absolute");
        overlay.classList.add("opacity-100");
        setTimeout(() => overlay.classList.remove("opacity-100"), 900);
      });

      container.prepend(node);
    }
  </script>
</body>
</html>
