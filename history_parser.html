<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Purchase, Upgrade & Selling Parser</title>
  <style>
    body {
      background: #121212;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 20px;
    }
    h2 {
      margin-top: 40px;
    }
    textarea {
      width: 100%;
      height: 120px;
      background: #1e1e1e;
      color: white;
      border: 1px solid #555;
      padding: 10px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #444;
      padding: 5px 8px;
    }
    th {
      background: #222;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px;
      border: none;
      margin-bottom: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <h1>Purchase, Upgrade & Selling Parser</h1>

<h2>Purchase</h2>
<textarea id="purchaseInput" placeholder="Paste purchase data here..."></textarea>
<button onclick="downloadCSV(purchaseData, 'purchase.csv')">Download Purchase CSV</button>
<div id="purchasePreview"></div>

<h2>Upgrade</h2>
<textarea id="upgradeInput" placeholder="Paste upgrade data here..."></textarea>
<button onclick="downloadCSV(upgradeData, 'upgrade.csv')">Download Upgrade CSV</button>
<div id="upgradePreview"></div>

<h2>Selling</h2>
<textarea id="sellingInput" placeholder="Paste selling data here..."></textarea>
<button onclick="downloadCSV(sellingData, 'selling.csv')">Download Selling CSV</button>
<div id="sellingPreview"></div>

<script>
globalThis.dateFormat = 'eu'; // 'us' fÃ¼r mm/dd/yyyy

const safe = v => (v || '').toString().trim();

const normalizeNumber = txt => {
  txt = safe(txt)
    .replace(/[^0-9.,]/g, '')
    .replace(/(?<=\\d),(?=\\d{3})/g, '')
    .replace(/(?<=\\d)\\.(?=\\d{3})/g, '')
    .replace(/,/g, '.');
  const num = parseFloat(txt);
  return isNaN(num) ? '' : num.toFixed(2).replace('.', ',');
};

const formatDate = d => {
  const [m, d2, y] = d.split('/');
  return globalThis.dateFormat === 'eu' ? \`\${d2}.\${m}.\${y}\` : d;
};

const extractBlocks = input => {
  const lines = input.split('\\n').map(l => l.trim()).filter(Boolean);
  const blocks = [];
  let current = [];
  for (const line of lines) {
    if (/\\d{1,2}\\/\\d{1,2}\\/\\d{4}/.test(line)) {
      if (current.length) blocks.push(current);
      current = [line];
    } else {
      current.push(line);
    }
  }
  if (current.length) blocks.push(current);
  return blocks;
};

const purchaseData = [];
const upgradeData = [];
const sellingData = [];

const parsePurchaseBlock = b => {
  if (b.length < 8) return;
  purchaseData.push({
    Date: formatDate(b[1]),
    Time: b[0],
    Miner: b[3],
    TH: normalizeNumber(b[4]),
    WTH: normalizeNumber(b[5]),
    Price: normalizeNumber(b[6]),
    Status: b[7]
  });
};

const parseUpgradeBlock = b => {
  if (b.length < 7) return;
  const entry = {
    Date: formatDate(b[0]),
    Miner: b[2],
    Price: normalizeNumber(b[5]),
    Status: b[6],
    "TH before": "",
    "TH": "",
    "W/TH before": "",
    "W/TH": "",
    "Upgrade Type": ""
  };
  const fromVal = b[3];
  const toVal = b[4];
  if (fromVal.includes("TH")) {
    entry["TH before"] = normalizeNumber(fromVal);
    entry["TH"] = normalizeNumber(toVal);
    entry["Upgrade Type"] = "Power";
  } else {
    entry["W/TH before"] = normalizeNumber(fromVal);
    entry["W/TH"] = normalizeNumber(toVal);
    entry["Upgrade Type"] = "Efficiency";
  }
  upgradeData.push(entry);
};

const parseSellingBlock = b => {
  if (b.length < 8) return;
  sellingData.push({
    Date: formatDate(b[0]),
    Miner: b[2],
    TH: normalizeNumber(b[3]),
    WTH: normalizeNumber(b[4]),
    PriceBuyer: normalizeNumber(b[5]),
    YouGet: normalizeNumber(b[6]),
    Status: b[7]
  });
};

const renderTable = (data, containerId) => {
  if (!data.length) return;
  const keys = Object.keys(data[0]);
  const html = [
    '<table><thead><tr>' + keys.map(k => '<th>' + k + '</th>').join('') + '</tr></thead><tbody>',
    ...data.map(row => '<tr>' + keys.map(k => '<td>' + safe(row[k]) + '</td>').join('') + '</tr>'),
    '</tbody></table>'
  ].join('');
  document.getElementById(containerId).innerHTML = html;
};

const downloadCSV = (data, filename) => {
  const keys = Object.keys(data[0]);
  const csv = [keys.join(';'), ...data.map(r => keys.map(k => safe(r[k])).join(';'))].join('\\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById("purchaseInput").addEventListener("paste", e => {
  setTimeout(() => {
    extractBlocks(e.target.value).forEach(parsePurchaseBlock);
    renderTable(purchaseData, "purchasePreview");
    e.target.value = "";
  }, 100);
});

document.getElementById("upgradeInput").addEventListener("paste", e => {
  setTimeout(() => {
    extractBlocks(e.target.value).forEach(parseUpgradeBlock);
    renderTable(upgradeData, "upgradePreview");
    e.target.value = "";
  }, 100);
});

document.getElementById("sellingInput").addEventListener("paste", e => {
  setTimeout(() => {
    extractBlocks(e.target.value).forEach(parseSellingBlock);
    renderTable(sellingData, "sellingPreview");
    e.target.value = "";
  }, 100);
});
</script>
</body>
</html>



